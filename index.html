<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="Professional construction site daily reporting system">
    
    <title>Daily Site Report PWA - Enhanced</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Site Report">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f3f4f6;
            line-height: 1.5;
            touch-action: manipulation;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            position: relative;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            margin-bottom: 4px;
            font-weight: 700;
        }
        
        .header-info {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* Status Bar */
        .status-bar {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .status-bar.delivered {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }
        
        .status-dot.offline {
            background: #ef4444;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 60px;
            z-index: 999;
        }
        
        .tab {
            flex: 1;
            padding: 12px 6px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            background: white;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            text-align: center;
            touch-action: manipulation;
        }
        
        .tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
            background: #eff6ff;
        }
        
        /* Content */
        .content {
            padding: 16px;
            padding-bottom: 80px;
            min-height: calc(100vh - 140px);
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }
        
        .card h3 {
            color: #1e40af;
            font-weight: 700;
            margin-bottom: 16px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Collapsible Sections */
        .section {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        .section-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 14px;
            touch-action: manipulation;
        }
        
        .section-content {
            padding: 16px;
            display: none;
        }
        
        .section-content.active {
            display: block;
        }
        
        .section-toggle {
            font-size: 14px;
            transition: transform 0.2s;
        }
        
        .section-toggle.rotated {
            transform: rotate(180deg);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .form-textarea {
            resize: none;
            font-family: inherit;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: #1e40af;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1e3a8a;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn-purple {
            background: #7c3aed;
            color: white;
        }
        
        .btn-purple:hover {
            background: #6d28d9;
        }
        
        .btn:disabled {
            background: #9ca3af;
            color: #6b7280;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Equipment/Materials List Styles */
        .equipment-list, .materials-list {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #f9fafb;
        }
        
        .equipment-item, .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
            margin: 4px;
            border-radius: 4px;
        }
        
        .equipment-item:last-child, .material-item:last-child {
            border-bottom: none;
        }
        
        .item-details {
            flex: 1;
            font-size: 14px;
        }
        
        .item-quantity {
            font-weight: 600;
            color: #1e40af;
            margin-right: 8px;
        }
        
        .remove-item-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .add-item-form {
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
        }
        
        /* Report Sections */
        .report-section {
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .report-section-header {
            background: #f3f4f6;
            padding: 12px 16px;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .report-section-content {
            padding: 16px;
        }
        
        .report-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .report-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .report-timestamp {
            background: #1e40af;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        /* Photo Section */
        .photo-section {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            background: #f9fafb;
            margin-bottom: 12px;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .photo-name {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        /* Activity Entry */
        .activity-entry {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .activity-time {
            background: #1e40af;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .activity-details {
            font-size: 13px;
            line-height: 1.4;
        }
        
        .activity-photos {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            overflow-x: auto;
        }
        
        .activity-photo {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        /* Summary Stats */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .summary-item {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            padding: 14px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #bfdbfe;
        }
        
        .summary-number {
            font-size: 22px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 2px;
        }
        
        .summary-label {
            font-size: 11px;
            color: #1e40af;
            font-weight: 600;
        }
        
        /* Messages */
        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
        }
        
        .message.success {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
        }
        
        .message.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #dc2626;
        }
        
        .message.info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        /* Delivery Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e40af;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .delivery-summary {
            margin-bottom: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1e40af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Install prompt */
        .install-prompt {
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            background: #1e40af;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
        }
        
        .install-prompt.show {
            display: flex;
        }
        
        .install-prompt button {
            background: white;
            color: #1e40af;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
        }
        
        /* Responsive */
        @media (max-width: 380px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .form-row-3 {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üèóÔ∏è Daily Site Report PWA</h1>
            <div class="header-info">
                <span id="current-date">Loading...</span> ‚Ä¢ <span id="current-time">Loading...</span>
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar" id="status-bar">
            <div>
                <div style="font-weight: 600;" id="report-title">üìÖ Today's Report</div>
                <div style="font-size: 11px; opacity: 0.9;">
                    <span id="activity-count">0</span> activities ‚Ä¢ 
                    <span id="total-reports">0</span> reports
                </div>
            </div>
            <div class="connection-status">
                <div class="status-dot" id="connection-dot"></div>
                <div>
                    <div style="font-weight: 600;" id="report-status">üü° In Progress</div>
                    <div id="sync-status">Syncing...</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('activity')">üìù Activity</button>
            <button class="tab" onclick="showTab('safety')">üõ°Ô∏è Safety</button>
            <button class="tab" onclick="showTab('progress')">üìà Progress + QA/QC</button>
            <button class="tab" onclick="showTab('report')">üìä Report</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Activity Tab -->
            <div id="activity-content" class="tab-content active">
                <!-- Site Overview Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('overview')">
                        <span>üèóÔ∏è Site Overview</span>
                        <span class="section-toggle" id="overview-toggle">‚ñº</span>
                    </div>
                    <div class="section-content active" id="overview-content">
                        <div class="form-group">
                            <label class="form-label">Project</label>
                            <select id="project-name" class="form-select">
                                <option value="">Select Project</option>
                                <option value="TPE11 Day 2">TPE11 Day 2</option>
                                <option value="Owner works">Owner works</option>
                                <option value="Tenant Works">Tenant Works</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                        
                        <div class="form-group hidden" id="custom-project-group">
                            <label class="form-label">Custom Project Name</label>
                            <input type="text" id="custom-project-name" placeholder="Enter project name..." class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Reported By</label>
                            <select id="reported-by" class="form-select">
                                <option value="">Select User</option>
                                <option value="user 1">user 1</option>
                                <option value="user 2">user 2</option>
                                <option value="user 3">user 3</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Weather</label>
                                <select id="weather" class="form-select">
                                    <option value="">Select Weather</option>
                                    <option value="Sunny">‚òÄÔ∏è Sunny</option>
                                    <option value="Partly Cloudy">‚õÖ Partly Cloudy</option>
                                    <option value="Cloudy">‚òÅÔ∏è Cloudy</option>
                                    <option value="Light Rain">üå¶Ô∏è Light Rain</option>
                                    <option value="Heavy Rain">üåßÔ∏è Heavy Rain</option>
                                    <option value="Windy">üí® Windy</option>
                                    <option value="Hot">üå°Ô∏è Hot</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Site Conditions</label>
                                <select id="site-conditions" class="form-select">
                                    <option value="">Select Conditions</option>
                                    <option value="Dry and Safe">Dry and Safe</option>
                                    <option value="Wet Surfaces">Wet Surfaces</option>
                                    <option value="Muddy Areas">Muddy Areas</option>
                                    <option value="Slippery Conditions">Slippery Conditions</option>
                                    <option value="Poor Visibility">Poor Visibility</option>
                                    <option value="Dusty Conditions">Dusty Conditions</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Details Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('activity-details')">
                        <span>‚è∞ Activity Details</span>
                        <span class="section-toggle rotated" id="activity-details-toggle">‚ñº</span>
                    </div>
                    <div class="section-content active" id="activity-details-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Start Time</label>
                                <select id="start-time" class="form-select">
                                    <option value="">Select Time</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Time</label>
                                <select id="end-time" class="form-select">
                                    <option value="">Select Time</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Building/Floor</label>
                                <select id="location" class="form-select">
                                    <option value="">Select Location</option>
                                    <option value="Ground Floor">Ground Floor</option>
                                    <option value="1st Floor">1st Floor</option>
                                    <option value="2nd Floor">2nd Floor</option>
                                    <option value="3rd Floor">3rd Floor</option>
                                    <option value="4th Floor">4th Floor</option>
                                    <option value="5th Floor">5th Floor</option>
                                    <option value="Basement 1">Basement 1</option>
                                    <option value="Basement 2">Basement 2</option>
                                    <option value="Rooftop">Rooftop</option>
                                    <option value="External Area">External Area</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Specific Area</label>
                                <select id="specific-area" class="form-select">
                                    <option value="">Select Area</option>
                                    <option value="North Wing">North Wing</option>
                                    <option value="South Wing">South Wing</option>
                                    <option value="East Wing">East Wing</option>
                                    <option value="West Wing">West Wing</option>
                                    <option value="Central Core">Central Core</option>
                                    <option value="Lobby Area">Lobby Area</option>
                                    <option value="Service Area">Service Area</option>
                                    <option value="Stairwell">Stairwell</option>
                                    <option value="Elevator Shaft">Elevator Shaft</option>
                                    <option value="Mechanical Room">Mechanical Room</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Room/Unit Details</label>
                            <input type="text" id="location-details" placeholder="e.g., Room 301, Unit A, Grid Line 5-8" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Contractor</label>
                            <select id="contractor" class="form-select">
                                <option value="">Select Contractor</option>
                                <option value="ABC Construction Ltd">ABC Construction Ltd</option>
                                <option value="BuildPro Engineering">BuildPro Engineering</option>
                                <option value="Elite Contractors">Elite Contractors</option>
                                <option value="MegaBuild Corp">MegaBuild Corp</option>
                                <option value="Premier Construction">Premier Construction</option>
                                <option value="Skyline Builders">Skyline Builders</option>
                                <option value="TechBuild Solutions">TechBuild Solutions</option>
                                <option value="Urban Development Co">Urban Development Co</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Work Details Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('work-details')">
                        <span>üîß Work Details</span>
                        <span class="section-toggle rotated" id="work-details-toggle">‚ñº</span>
                    </div>
                    <div class="section-content active" id="work-details-content">
                        <div class="form-group">
                            <label class="form-label">Work Category</label>
                            <select id="work-category" class="form-select">
                                <option value="">Select Category</option>
                                <option value="Structural">Structural Work</option>
                                <option value="Mechanical">Mechanical Work</option>
                                <option value="Electrical">Electrical Work</option>
                                <option value="Plumbing">Plumbing Work</option>
                                <option value="HVAC">HVAC Work</option>
                                <option value="Fire Safety">Fire Safety</option>
                                <option value="Finishes">Finishes & Fixtures</option>
                                <option value="Landscaping">Landscaping</option>
                                <option value="Testing">Testing & Commissioning</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Specific Work Type</label>
                            <select id="work-type" class="form-select" disabled>
                                <option value="">Select Work Type</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Work Description</label>
                            <textarea id="work-description" placeholder="Detailed description of work performed..." rows="3" class="form-textarea"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Work Status</label>
                                <select id="work-status" class="form-select">
                                    <option value="">Select Status</option>
                                    <option value="Started">Started</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="50% Complete">50% Complete</option>
                                    <option value="75% Complete">75% Complete</option>
                                    <option value="Completed">Completed</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Delayed">Delayed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quality Status</label>
                                <select id="quality-status" class="form-select">
                                    <option value="">Select Quality</option>
                                    <option value="Excellent">Excellent</option>
                                    <option value="Good">Good</option>
                                    <option value="Satisfactory">Satisfactory</option>
                                    <option value="Needs Improvement">Needs Improvement</option>
                                    <option value="Failed Inspection">Failed Inspection</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manpower & Equipment Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('manpower')">
                        <span>üë• Manpower & Equipment</span>
                        <span class="section-toggle" id="manpower-toggle">‚ñº</span>
                    </div>
                    <div class="section-content" id="manpower-content">
                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">Workers</label>
                                <select id="worker-count" class="form-select">
                                    <option value="">Count</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20+</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supervisors</label>
                                <select id="supervisor-count" class="form-select">
                                    <option value="">Count</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Specialists</label>
                                <select id="specialist-count" class="form-select">
                                    <option value="">Count</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Equipment Section -->
                        <div class="form-group">
                            <label class="form-label">Equipment & Plant Used</label>
                            
                            <!-- Equipment List Display -->
                            <div class="equipment-list" id="equipment-list">
                                <div style="padding: 12px; text-align: center; color: #6b7280; font-size: 14px;">
                                    No equipment added yet
                                </div>
                            </div>
                            
                            <!-- Add Equipment Form -->
                            <div class="add-item-form">
                                <div class="form-row">
                                    <div class="form-group" style="margin-bottom: 8px;">
                                        <select id="new-equipment" class="form-select" style="font-size: 13px; padding: 8px;">
                                            <option value="">Select Equipment</option>
                                            <option value="Tower Crane">Tower Crane</option>
                                            <option value="Mobile Crane">Mobile Crane</option>
                                            <option value="Excavator">Excavator</option>
                                            <option value="Concrete Mixer">Concrete Mixer</option>
                                            <option value="Scaffold System">Scaffold System</option>
                                            <option value="Working Platform">Working Platform</option>
                                            <option value="Welding Equipment">Welding Equipment</option>
                                            <option value="Compactor">Compactor</option>
                                            <option value="Generator">Generator</option>
                                            <option value="Concrete Pump">Concrete Pump</option>
                                            <option value="Hand Tools">Hand Tools</option>
                                            <option value="Safety Equipment">Safety Equipment</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 8px;">
                                        <input type="number" id="new-equipment-quantity" placeholder="Qty" min="1" class="form-input" style="font-size: 13px; padding: 8px;">
                                    </div>
                                </div>
                                <button onclick="addEquipment()" class="btn btn-primary" style="padding: 8px; font-size: 13px;">
                                    ‚ûï Add Equipment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Materials Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('materials')">
                        <span>üì¶ Materials Used</span>
                        <span class="section-toggle" id="materials-toggle">‚ñº</span>
                    </div>
                    <div class="section-content" id="materials-content">
                        <div class="form-group">
                            <label class="form-label">Materials Used</label>
                            
                            <!-- Materials List Display -->
                            <div class="materials-list" id="materials-list">
                                <div style="padding: 12px; text-align: center; color: #6b7280; font-size: 14px;">
                                    No materials added yet
                                </div>
                            </div>
                            
                            <!-- Add Materials Form -->
                            <div class="add-item-form">
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <select id="new-material" class="form-select" style="font-size: 13px; padding: 8px;">
                                        <option value="">Select Material Type</option>
                                        <option value="Concrete">Concrete</option>
                                        <option value="Steel/Rebar">Steel/Rebar</option>
                                        <option value="Bricks/Blocks">Bricks/Blocks</option>
                                        <option value="Electrical Materials">Electrical Materials</option>
                                        <option value="Plumbing Materials">Plumbing Materials</option>
                                        <option value="HVAC Components">HVAC Components</option>
                                        <option value="Windows/Doors">Windows/Doors</option>
                                        <option value="Paint/Coatings">Paint/Coatings</option>
                                        <option value="Tiles/Flooring">Tiles/Flooring</option>
                                        <option value="Insulation">Insulation</option>
                                        <option value="Fasteners">Fasteners</option>
                                        <option value="Sealants">Sealants</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <input type="text" id="new-material-details" placeholder="Details & quantity (e.g., 5 bags, 10 m¬≥, 200 pieces)" class="form-input" style="font-size: 13px; padding: 8px;">
                                </div>
                                <button onclick="addMaterial()" class="btn btn-primary" style="padding: 8px; font-size: 13px;">
                                    ‚ûï Add Material
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photos Section with Expandable Feature -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('photos')">
                        <span>üì∏ Photos</span>
                        <span class="section-toggle" id="photos-toggle">‚ñº</span>
                    </div>
                    <div class="section-content" id="photos-content">
                        <div id="activity-photos-container">
                            <!-- Default 2 photo slots -->
                            <div class="form-row">
                                <div class="photo-section">
                                    <label class="form-label">Before Photo</label>
                                    <div id="photo1-preview" class="hidden">
                                        <img id="photo1-img" class="photo-preview">
                                        <div class="photo-name" id="photo1-name"></div>
                                        <button onclick="removePhoto(1)" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                    <div id="photo1-input">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                            <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                                                üì∑ Camera
                                                <input type="file" id="photo1-camera" accept="image/*" capture="environment" style="display: none;">
                                            </label>
                                            <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                                                üìÅ Gallery
                                                <input type="file" id="photo1-gallery" accept="image/*" style="display: none;">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="photo-section">
                                    <label class="form-label">After Photo</label>
                                    <div id="photo2-preview" class="hidden">
                                        <img id="photo2-img" class="photo-preview">
                                        <div class="photo-name" id="photo2-name"></div>
                                        <button onclick="removePhoto(2)" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                    <div id="photo2-input">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                            <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                                                üì∑ Camera
                                                <input type="file" id="photo2-camera" accept="image/*" capture="environment" style="display: none;">
                                            </label>
                                            <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                                                üìÅ Gallery
                                                <input type="file" id="photo2-gallery" accept="image/*" style="display: none;">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Additional photo slots will be added here -->
                        </div>
                        
                        <!-- Add More Photos Button -->
                        <div style="text-align: center; margin-top: 12px;">
                            <button onclick="addMoreActivityPhotos()" class="btn" id="add-activity-photos-btn" style="background: #6b7280; color: white; padding: 8px 16px; font-size: 13px;">
                                ‚ûï Add More Photos (Max 6)
                            </button>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                <span id="activity-photo-count">2</span> of 6 photo slots available
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Remarks Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('remarks')">
                        <span>üí¨ Remarks</span>
                        <span class="section-toggle" id="remarks-toggle">‚ñº</span>
                    </div>
                    <div class="section-content" id="remarks-content">
                        <div class="form-group">
                            <label class="form-label">Safety Notes</label>
                            <textarea id="activity-safety-remarks" placeholder="Safety observations for this activity..." rows="2" class="form-textarea"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">General Remarks</label>
                            <textarea id="activity-general-remarks" placeholder="Other notes and observations..." rows="2" class="form-textarea"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Add Activity Button -->
                <button onclick="addActivity()" class="btn btn-success" style="margin-top: 16px; font-size: 16px;">
                    ‚ûï Add Activity to Report
                </button>
                
                <div id="activity-message"></div>
            </div>

            <!-- Safety Tab -->
            <div id="safety-content" class="tab-content">
                <!-- Section 1: Overall Safety Performance -->
                <div class="card">
                    <h3>üõ°Ô∏è Section 1: Overall Safety Performance</h3>
                    <div class="form-group">
                        <label class="form-label">Overall Safety Status</label>
                        <select id="safety-status" class="form-select">
                            <option value="">Select Status</option>
                            <option value="Excellent">üü¢ Excellent - No Issues</option>
                            <option value="Good">üü° Good - Minor Issues</option>
                            <option value="Fair">üü† Fair - Some Concerns</option>
                            <option value="Poor">üî¥ Poor - Major Issues</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Safety Officer Present</label>
                            <select id="safety-officer" class="form-select">
                                <option value="">Select</option>
                                <option value="Full Day">Yes - Full Day</option>
                                <option value="Partial Day">Yes - Partial Day</option>
                                <option value="Not Present">No - Not Present</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">PPE Compliance</label>
                            <select id="ppe-compliance" class="form-select">
                                <option value="">Select Compliance</option>
                                <option value="100%">100% Compliant</option>
                                <option value="95%">95% Compliant</option>
                                <option value="90%">90% Compliant</option>
                                <option value="Below 90%">Below 90%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Safety Observations</label>
                        <textarea id="safety-observations" placeholder="General safety observations, incidents, actions taken..." rows="3" class="form-textarea"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Link to Relevant Activity</label>
                        <select id="linked-activity" class="form-select">
                            <option value="">Select Activity</option>
                        </select>
                    </div>

                    <!-- Safety Photos Section with Expandable Feature -->
                    <div class="form-group">
                        <label class="form-label">Safety Photos</label>
                        <div id="safety-photos-container">
                            <!-- Default 2 photo slots -->
                            <div class="form-row">
                                <div class="photo-section">
                                    <label class="form-label">Safety Photo 1</label>
                                    <div id="safety-photo1-preview" class="hidden">
                                        <img id="safety-photo1-img" class="photo-preview">
                                        <div class="photo-name" id="safety-photo1-name"></div>
                                        <button onclick="removeSafetyPhoto(1)" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                    <div id="safety-photo1-input">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                            <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                                                üì∑ Camera
                                                <input type="file" id="safety-photo1-camera" accept="image/*" capture="environment" style="display: none;">
                                            </label>
                                            <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                                                üìÅ Gallery
                                                <input type="file" id="safety-photo1-gallery" accept="image/*" style="display: none;">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="photo-section">
                                    <label class="form-label">Safety Photo 2</label>
                                    <div id="safety-photo2-preview" class="hidden">
                                        <img id="safety-photo2-img" class="photo-preview">
                                        <div class="photo-name" id="safety-photo2-name"></div>
                                        <button onclick="removeSafetyPhoto(2)" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                    <div id="safety-photo2-input">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                            <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                                                üì∑ Camera
                                                <input type="file" id="safety-photo2-camera" accept="image/*" capture="environment" style="display: none;">
                                            </label>
                                            <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                                                üìÅ Gallery
                                                <input type="file" id="safety-photo2-gallery" accept="image/*" style="display: none;">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Additional photo slots will be added here -->
                        </div>
                        
                        <!-- Add More Photos Button -->
                        <div style="text-align: center; margin-top: 12px;">
                            <button onclick="addMoreSafetyPhotos()" class="btn" id="add-safety-photos-btn" style="background: #6b7280; color: white; padding: 8px 16px; font-size: 13px;">
                                ‚ûï Add More Photos (Max 6)
                            </button>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                <span id="safety-photo-count">2</span> of 6 photo slots available
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Near-Miss Issues -->
                <div class="card">
                    <h3>‚ö†Ô∏è Section 2: Near-Miss Issues</h3>
                    <div class="form-group">
                        <label class="form-label">Near-Miss Issue Record</label>
                        <textarea id="near-miss-record" placeholder="Describe the near-miss incident in detail: what happened, where, when, who was involved..." rows="4" class="form-textarea"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Near-Miss Issue Range (Risk Level)</label>
                        <select id="near-miss-range" class="form-select">
                            <option value="">Select Risk Level</option>
                            <option value="Low Risk">üü¢ Low Risk - No injury potential</option>
                            <option value="Medium Risk">üü° Medium Risk - Minor injury potential</option>
                            <option value="High Risk">üü† High Risk - Serious injury potential</option>
                            <option value="Critical Risk">üî¥ Critical Risk - Fatal injury potential</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Corrective Actions Taken</label>
                        <textarea id="corrective-actions" placeholder="Actions taken to prevent recurrence, responsible person, timeline..." rows="3" class="form-textarea"></textarea>
                    </div>

                    <!-- Add Safety Status Button -->
                    <button onclick="addSafetyStatus()" class="btn btn-success" style="margin-top: 16px; font-size: 16px;">
                        üõ°Ô∏è Add Safety Status to Report
                    </button>
                    
                    <div id="safety-message"></div>
                </div>
            </div>

            <!-- Progress + QA/QC Tab -->
            <div id="progress-content" class="tab-content">
                <div class="card">
                    <h3>üìà Daily Progress</h3>
                    <div class="form-group">
                        <label class="form-label">Progress Rating</label>
                        <select id="progress-rating" class="form-select">
                            <option value="">Rate Today's Progress</option>
                            <option value="Excellent">üü¢ Excellent - Ahead of Schedule</option>
                            <option value="Good">üü° Good - On Schedule</option>
                            <option value="Fair">üü† Fair - Minor Delays</option>
                            <option value="Poor">üî¥ Poor - Behind Schedule</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Key Achievements</label>
                        <textarea id="key-achievements" placeholder="Major achievements and milestones..." rows="3" class="form-textarea"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Issues & Challenges</label>
                        <textarea id="issues-challenges" placeholder="Problems encountered and solutions..." rows="3" class="form-textarea"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tomorrow's Plan</label>
                        <textarea id="tomorrow-plan" placeholder="Planned activities for tomorrow..." rows="2" class="form-textarea"></textarea>
                    </div>

                    <!-- Add Progress Button -->
                    <button onclick="addProgress()" class="btn btn-success" style="margin-top: 16px; font-size: 16px;">
                        üìà Add Progress to Report
                    </button>
                    
                    <div id="progress-message"></div>
                </div>

                <div class="card">
                    <h3>üîç QA/QC</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Overall Quality</label>
                            <select id="overall-quality" class="form-select">
                                <option value="">Select Quality</option>
                                <option value="Excellent">üü¢ Excellent</option>
                                <option value="Good">üü° Good</option>
                                <option value="Acceptable">üü† Acceptable</option>
                                <option value="Poor">üî¥ Poor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rework Required</label>
                            <select id="rework-required" class="form-select">
                                <option value="">Select Status</option>
                                <option value="No Rework">No Rework Required</option>
                                <option value="Minor Rework">Minor Rework Required</option>
                                <option value="Major Rework">Major Rework Required</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Quality Issues</label>
                        <textarea id="quality-issues" placeholder="Quality problems and corrective actions..." rows="2" class="form-textarea"></textarea>
                    </div>

                    <!-- QA/QC Photos Section with Expandable Feature -->
                    <div class="form-group">
                        <label class="form-label">QA/QC Photos</label>
                        <div id="qaqc-photos-container">
                            <!-- Default 2 photo slots -->
                            <div class="form-row">
                                <div class="photo-section">
                                    <label class="form-label">QA/QC Photo 1</label>
                                    <div id="qaqc-photo1-preview" class="hidden">
                                        <img id="qaqc-photo1-img" class="photo-preview">
                                        <div class="photo-name" id="qaqc-photo1-name"></div>
                                        <button onclick="removeQAQCPhoto(1)" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                    <div id="qaqc-photo1-input">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                            <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                                                üì∑ Camera
                                                <input type="file" id="qaqc-photo1-camera" accept="image/*" capture="environment" style="display: none;">
                                            </label>
                                            <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                                                üìÅ Gallery
                                                <input type="file" id="qaqc-photo1-gallery" accept="image/*" style="display: none;">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="photo-section">
                                    <label class="form-label">QA/QC Photo 2</label>
                                    <div id="qaqc-photo2-preview" class="hidden">
                                        <img id="qaqc-photo2-img" class="photo-preview">
                                        <div class="photo-name" id="qaqc-photo2-name"></div>
                                        <button onclick="removeQAQCPhoto(2)" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                    <div id="qaqc-photo2-input">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                            <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                                                üì∑ Camera
                                                <input type="file" id="qaqc-photo2-camera" accept="image/*" capture="environment" style="display: none;">
                                            </label>
                                            <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                                                üìÅ Gallery
                                                <input type="file" id="qaqc-photo2-gallery" accept="image/*" style="display: none;">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Additional photo slots will be added here -->
                        </div>
                        
                        <!-- Add More Photos Button -->
                        <div style="text-align: center; margin-top: 12px;">
                            <button onclick="addMoreQAQCPhotos()" class="btn" id="add-qaqc-photos-btn" style="background: #6b7280; color: white; padding: 8px 16px; font-size: 13px;">
                                ‚ûï Add More Photos (Max 6)
                            </button>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                <span id="qaqc-photo-count">2</span> of 6 photo slots available
                            </div>
                        </div>
                    </div>

                    <!-- Add QA/QC Button -->
                    <button onclick="addQualityControl()" class="btn btn-success" style="margin-top: 16px; font-size: 16px;">
                        üîç Add QA/QC to Report
                    </button>
                    
                    <div id="quality-message"></div>
                </div>
            </div>

            <!-- Report Tab -->
            <div id="report-content" class="tab-content">
                <div class="card">
                    <h3>üìä Daily Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-number" id="total-activities">0</div>
                            <div class="summary-label">Activities</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="total-workers">0</div>
                            <div class="summary-label">Workers</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="active-contractors">0</div>
                            <div class="summary-label">Contractors</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="work-hours">0</div>
                            <div class="summary-label">Work Hours</div>
                        </div>
                    </div>
                </div>

                <!-- Complete Report Display -->
                <div id="complete-report-display">
                    <!-- Activities Section -->
                    <div class="report-section">
                        <div class="report-section-header">
                            üìù Activities (<span id="activities-count">0</span>)
                        </div>
                        <div class="report-section-content" id="activities-report">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">
                                No activities recorded yet
                            </div>
                        </div>
                    </div>

                    <!-- Safety Reports Section -->
                    <div class="report-section">
                        <div class="report-section-header">
                            üõ°Ô∏è Safety Reports (<span id="safety-count">0</span>)
                        </div>
                        <div class="report-section-content" id="safety-reports">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">
                                No safety reports added yet
                            </div>
                        </div>
                    </div>

                    <!-- Progress Reports Section -->
                    <div class="report-section">
                        <div class="report-section-header">
                            üìà Progress Reports (<span id="progress-count">0</span>)
                        </div>
                        <div class="report-section-content" id="progress-reports">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">
                                No progress reports added yet
                            </div>
                        </div>
                    </div>

                    <!-- QA/QC Reports Section -->
                    <div class="report-section">
                        <div class="report-section-header">
                            üîç QA/QC Reports (<span id="quality-count">0</span>)
                        </div>
                        <div class="report-section-content" id="quality-reports">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">
                                No QA/QC reports added yet
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üì§ Export Report</h3>
                    
                    <!-- Deliver Report Button -->
                    <div class="form-group">
                        <button onclick="deliverReport()" class="btn btn-purple" id="deliver-btn" disabled>
                            <span class="loading hidden" id="deliver-loading"></span>
                            <span id="deliver-text">üìã Deliver Report</span>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button onclick="downloadCSV()" class="btn btn-success" id="download-csv-btn" disabled>
                            <span class="loading hidden" id="csv-loading"></span>
                            <span id="csv-text">‚¨áÔ∏è Download CSV Report</span>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button onclick="syncToCloud()" class="btn btn-primary" id="sync-btn" disabled>
                            <span class="loading hidden" id="sync-loading"></span>
                            <span id="sync-text">‚òÅÔ∏è Sync to Cloud</span>
                        </button>
                    </div>
                    
                    <p id="export-status" style="text-align: center; color: #6b7280; margin-top: 12px; font-size: 14px;">
                        Add data to enable export
                    </p>
                    
                    <div class="message info">
                        <strong>üí° Workflow:</strong><br>
                        1. Add activities, safety, progress, and QA/QC reports<br>
                        2. Deliver report to finalize all entries<br>
                        3. Download CSV or sync to cloud<br>
                        4. Share via WhatsApp/Email for processing
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div id="delivery-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìã Deliver Daily Report</div>
                <button class="close-modal" onclick="closeDeliveryModal()">&times;</button>
            </div>
            
            <div class="delivery-summary">
                <p style="margin-bottom: 16px; color: #6b7280;">
                    Please review the summary below and confirm that all activities have been recorded for today.
                </p>
                
                <div class="summary-row">
                    <span><strong>üìù Activities:</strong></span>
                    <span id="modal-activities">0</span>
                </div>
                <div class="summary-row">
                    <span><strong>üõ°Ô∏è Safety Reports:</strong></span>
                    <span id="modal-safety">0</span>
                </div>
                <div class="summary-row">
                    <span><strong>üìà Progress Reports:</strong></span>
                    <span id="modal-progress">0</span>
                </div>
                <div class="summary-row">
                    <span><strong>üîç QA/QC Reports:</strong></span>
                    <span id="modal-quality">0</span>
                </div>
                <div class="summary-row">
                    <span><strong>üë• Total Workers:</strong></span>
                    <span id="modal-workers">0</span>
                </div>
                <div class="summary-row">
                    <span><strong>üè¢ Contractors:</strong></span>
                    <span id="modal-contractors">0</span>
                </div>
                <div class="summary-row">
                    <span><strong>üìÖ Report Date:</strong></span>
                    <span id="modal-date">Today</span>
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <p style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">
                    ‚úÖ I confirm that:
                </p>
                <ul style="font-size: 14px; color: #6b7280; list-style-position: inside;">
                    <li>All activities for today have been recorded</li>
                    <li>Safety, progress, and quality information is complete</li>
                    <li>The report is ready for delivery and export</li>
                </ul>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="closeDeliveryModal()" class="btn" style="background: #6b7280; color: white;">
                    Cancel
                </button>
                <button onclick="confirmDelivery()" class="btn btn-purple">
                    üöÄ Confirm Delivery
                </button>
            </div>
        </div>
    </div>

    <!-- Install Prompt -->
    <div class="install-prompt" id="install-prompt">
        <div>
            <strong>üì± Install Site Report App</strong><br>
            <span style="font-size: 12px;">Add to home screen for better experience</span>
        </div>
        <div>
            <button onclick="installApp()">Install</button>
            <button onclick="dismissInstall()" style="background: transparent; color: white; margin-left: 8px;">Later</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

        // TODO: Replace with your Firebase config
        const firebaseConfig = {
            // You'll need to replace this with your actual Firebase config
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        let app, db, storage;
        let isOnline = navigator.onLine;
        
        // Initialize Firebase if config is provided
        try {
            if (firebaseConfig.apiKey !== "your-api-key") {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                storage = getStorage(app);
                console.log('Firebase initialized successfully');
            } else {
                console.log('Firebase config not set, running in offline mode');
            }
        } catch (error) {
            console.log('Firebase initialization failed, running in offline mode:', error);
        }

        // Make Firebase available globally
        window.firebase = { app, db, storage, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, ref, uploadBytes, getDownloadURL };
        window.isOnline = isOnline;
    </script>

    <script>
        // Global variables
        let dailyActivities = [];
        let dailySafetyReports = [];
        let dailyProgressReports = [];
        let dailyQualityReports = [];
        let photos = {1: null, 2: null, 3: null, 4: null, 5: null, 6: null};
        let safetyPhotos = {1: null, 2: null, 3: null, 4: null, 5: null, 6: null};
        let qaqcPhotos = {1: null, 2: null, 3: null, 4: null, 5: null, 6: null};
        let deferredPrompt;
        let isAppInstalled = false;
        let isReportDelivered = false;

        // Photo slot tracking
        let activityPhotoSlots = 2;
        let safetyPhotoSlots = 2;
        let qaqcPhotoSlots = 2;

        // Equipment and Materials arrays
        let activityEquipment = [];
        let activityMaterials = [];

        // Work type mappings
        const workTypeMap = {
            'Structural': ['Concrete Pouring', 'Reinforcement Installation', 'Formwork Setup', 'Steel Erection', 'Foundation Work'],
            'Mechanical': ['Pipe Installation', 'Valve Installation', 'Pump Installation', 'Equipment Mounting', 'Pressure Testing'],
            'Electrical': ['Cable Installation', 'Panel Installation', 'Lighting Installation', 'Testing & Commissioning'],
            'Plumbing': ['Water Pipe Installation', 'Drainage Installation', 'Fixture Installation', 'Leak Repairs'],
            'HVAC': ['Ductwork Installation', 'AC Unit Installation', 'Ventilation Setup', 'System Testing'],
            'Fire Safety': ['Sprinkler Installation', 'Fire Alarm Setup', 'Smoke Detector Installation', 'System Testing'],
            'Finishes': ['Painting', 'Tiling', 'Flooring Installation', 'Door Installation', 'Window Installation'],
            'Landscaping': ['Excavation', 'Planting', 'Irrigation Setup', 'Paving', 'Site Cleanup'],
            'Testing': ['Quality Inspections', 'Safety Testing', 'Performance Testing', 'Final Inspections'],
            'Maintenance': ['Routine Maintenance', 'Repair Work', 'Equipment Service', 'Cleaning']
        };

        // Initialize app
        function init() {
            console.log('Initializing Daily Site Report PWA...');
            
            try {
                // Set current time
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                // Generate time options (only :00 and :30)
                generateTimeOptions();
                
                // Set initial start time
                setCurrentTime();
                
                // Setup event listeners
                setupEventListeners();
                
                // Update connection status
                updateConnectionStatus();
                
                // Auto-save every 2 minutes
                setInterval(autoSave, 2 * 60 * 1000);
                
                // Load saved data
                loadSavedData();
                
                // Setup online/offline listeners
                window.addEventListener('online', () => {
                    window.isOnline = true;
                    updateConnectionStatus();
                    autoSyncToCloud();
                });
                
                window.addEventListener('offline', () => {
                    window.isOnline = false;
                    updateConnectionStatus();
                });
                
                console.log('PWA initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Update date and time display
        function updateDateTime() {
            try {
                const now = new Date();
                const dateEl = document.getElementById('current-date');
                const timeEl = document.getElementById('current-time');
                
                if (dateEl) dateEl.textContent = now.toLocaleDateString();
                if (timeEl) timeEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (error) {
                console.warn('DateTime update failed:', error);
            }
        }

        // Generate time options (only :00 and :30)
        function generateTimeOptions() {
            const startSelect = document.getElementById('start-time');
            const endSelect = document.getElementById('end-time');
            
            for (let hour = 0; hour < 24; hour++) {
                const hourStr = hour.toString().padStart(2, '0');
                
                // Add :00 option
                const option00Start = document.createElement('option');
                option00Start.value = `${hourStr}:00`;
                option00Start.textContent = `${hourStr}:00`;
                startSelect.appendChild(option00Start);
                
                const option00End = document.createElement('option');
                option00End.value = `${hourStr}:00`;
                option00End.textContent = `${hourStr}:00`;
                endSelect.appendChild(option00End);
                
                // Add :30 option
                const option30Start = document.createElement('option');
                option30Start.value = `${hourStr}:30`;
                option30Start.textContent = `${hourStr}:30`;
                startSelect.appendChild(option30Start);
                
                const option30End = document.createElement('option');
                option30End.value = `${hourStr}:30`;
                option30End.textContent = `${hourStr}:30`;
                endSelect.appendChild(option30End);
            }
        }

        // Set current time rounded to nearest 30 minutes
        function setCurrentTime() {
            const now = new Date();
            const minutes = now.getMinutes();
            const roundedMinutes = minutes < 30 ? '00' : '30';
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${roundedMinutes}`;
            
            document.getElementById('start-time').value = timeString;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Project name change
            document.getElementById('project-name').addEventListener('change', handleProjectChange);
            
            // Work category change
            document.getElementById('work-category').addEventListener('change', updateWorkTypes);
            
            // Activity photo upload handlers (default 2 slots)
            document.getElementById('photo1-camera').addEventListener('change', (e) => handlePhoto(1, e));
            document.getElementById('photo1-gallery').addEventListener('change', (e) => handlePhoto(1, e));
            document.getElementById('photo2-camera').addEventListener('change', (e) => handlePhoto(2, e));
            document.getElementById('photo2-gallery').addEventListener('change', (e) => handlePhoto(2, e));
            
            // Safety photo upload handlers (default 2 slots)
            document.getElementById('safety-photo1-camera').addEventListener('change', (e) => handleSafetyPhoto(1, e));
            document.getElementById('safety-photo1-gallery').addEventListener('change', (e) => handleSafetyPhoto(1, e));
            document.getElementById('safety-photo2-camera').addEventListener('change', (e) => handleSafetyPhoto(2, e));
            document.getElementById('safety-photo2-gallery').addEventListener('change', (e) => handleSafetyPhoto(2, e));
            
            // QA/QC photo upload handlers (default 2 slots)
            document.getElementById('qaqc-photo1-camera').addEventListener('change', (e) => handleQAQCPhoto(1, e));
            document.getElementById('qaqc-photo1-gallery').addEventListener('change', (e) => handleQAQCPhoto(1, e));
            document.getElementById('qaqc-photo2-camera').addEventListener('change', (e) => handleQAQCPhoto(2, e));
            document.getElementById('qaqc-photo2-gallery').addEventListener('change', (e) => handleQAQCPhoto(2, e));
        }

        // Tab navigation
        function showTab(tabName) {
            try {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                const targetContent = document.getElementById(tabName + '-content');
                if (targetContent) {
                    targetContent.classList.add('active');
                }
                
                // Add active class to clicked tab
                event.target.classList.add('active');
                
                // Update linked activities dropdown in safety tab
                if (tabName === 'safety') {
                    updateLinkedActivities();
                }
            } catch (error) {
                console.error('Tab switching error:', error);
            }
        }

        // Toggle collapsible sections
        function toggleSection(sectionName) {
            try {
                const content = document.getElementById(sectionName + '-content');
                const toggle = document.getElementById(sectionName + '-toggle');
                
                if (content && toggle) {
                    if (content.classList.contains('active')) {
                        content.classList.remove('active');
                        toggle.classList.remove('rotated');
                    } else {
                        content.classList.add('active');
                        toggle.classList.add('rotated');
                    }
                }
            } catch (error) {
                console.error('Section toggle error:', error);
            }
        }

        // Handle project change
        function handleProjectChange() {
            try {
                const projectSelect = document.getElementById('project-name');
                const customGroup = document.getElementById('custom-project-group');
                
                if (projectSelect.value === 'Others') {
                    customGroup.classList.remove('hidden');
                } else {
                    customGroup.classList.add('hidden');
                    document.getElementById('custom-project-name').value = '';
                }
            } catch (error) {
                console.error('Project change error:', error);
            }
        }

        // Update work types based on category
        function updateWorkTypes() {
            try {
                const category = document.getElementById('work-category').value;
                const workTypeSelect = document.getElementById('work-type');
                
                // Clear current options
                workTypeSelect.innerHTML = '<option value="">Select Work Type</option>';
                workTypeSelect.disabled = !category;
                
                if (category && workTypeMap[category]) {
                    workTypeMap[category].forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        workTypeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Update work types error:', error);
            }
        }

        // Equipment Management Functions
        function addEquipment() {
            try {
                const equipmentSelect = document.getElementById('new-equipment');
                const quantityInput = document.getElementById('new-equipment-quantity');
                
                const equipment = equipmentSelect.value;
                const quantity = parseInt(quantityInput.value);
                
                if (!equipment || !quantity || quantity < 1) {
                    showMessage('‚ùå Please select equipment and enter quantity', 'error');
                    return;
                }
                
                // Check if equipment already exists
                const existingIndex = activityEquipment.findIndex(item => item.equipment === equipment);
                if (existingIndex !== -1) {
                    activityEquipment[existingIndex].quantity += quantity;
                } else {
                    activityEquipment.push({
                        equipment: equipment,
                        quantity: quantity,
                        id: Date.now()
                    });
                }
                
                // Clear inputs
                equipmentSelect.value = '';
                quantityInput.value = '';
                
                // Update display
                updateEquipmentDisplay();
                showMessage('‚úÖ Equipment added!', 'success');
                
            } catch (error) {
                console.error('Add equipment error:', error);
                showMessage('‚ùå Failed to add equipment', 'error');
            }
        }

        function removeEquipment(id) {
            try {
                activityEquipment = activityEquipment.filter(item => item.id !== id);
                updateEquipmentDisplay();
                showMessage('‚úÖ Equipment removed', 'success');
            } catch (error) {
                console.error('Remove equipment error:', error);
            }
        }

        function updateEquipmentDisplay() {
            const equipmentList = document.getElementById('equipment-list');
            
            if (activityEquipment.length === 0) {
                equipmentList.innerHTML = '<div style="padding: 12px; text-align: center; color: #6b7280; font-size: 14px;">No equipment added yet</div>';
            } else {
                equipmentList.innerHTML = activityEquipment.map(item => `
                    <div class="equipment-item">
                        <div class="item-details">
                            <span class="item-quantity">${item.quantity}x</span>
                            ${item.equipment}
                        </div>
                        <button class="remove-item-btn" onclick="removeEquipment(${item.id})">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
        }

        // Materials Management Functions
        function addMaterial() {
            try {
                const materialSelect = document.getElementById('new-material');
                const detailsInput = document.getElementById('new-material-details');
                
                const material = materialSelect.value;
                const details = detailsInput.value.trim();
                
                if (!material || !details) {
                    showMessage('‚ùå Please select material type and enter details', 'error');
                    return;
                }
                
                activityMaterials.push({
                    material: material,
                    details: details,
                    id: Date.now()
                });
                
                // Clear inputs
                materialSelect.value = '';
                detailsInput.value = '';
                
                // Update display
                updateMaterialsDisplay();
                showMessage('‚úÖ Material added!', 'success');
                
            } catch (error) {
                console.error('Add material error:', error);
                showMessage('‚ùå Failed to add material', 'error');
            }
        }

        function removeMaterial(id) {
            try {
                activityMaterials = activityMaterials.filter(item => item.id !== id);
                updateMaterialsDisplay();
                showMessage('‚úÖ Material removed', 'success');
            } catch (error) {
                console.error('Remove material error:', error);
            }
        }

        function updateMaterialsDisplay() {
            const materialsList = document.getElementById('materials-list');
            
            if (activityMaterials.length === 0) {
                materialsList.innerHTML = '<div style="padding: 12px; text-align: center; color: #6b7280; font-size: 14px;">No materials added yet</div>';
            } else {
                materialsList.innerHTML = activityMaterials.map(item => `
                    <div class="material-item">
                        <div class="item-details">
                            <div style="font-weight: 600;">${item.material}</div>
                            <div style="font-size: 12px; color: #6b7280;">${item.details}</div>
                        </div>
                        <button class="remove-item-btn" onclick="removeMaterial(${item.id})">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
        }

        // Activity Photo functions
        function handlePhoto(photoNum, event) {
            try {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('‚ùå Photo too large. Max 5MB allowed.', 'error');
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showMessage('‚ùå Please select a valid image file.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        photos[photoNum] = {
                            data: e.target.result,
                            name: file.name,
                            size: file.size
                        };
                        
                        // Show preview
                        document.getElementById(`photo${photoNum}-img`).src = e.target.result;
                        document.getElementById(`photo${photoNum}-name`).textContent = file.name;
                        document.getElementById(`photo${photoNum}-preview`).classList.remove('hidden');
                        document.getElementById(`photo${photoNum}-input`).classList.add('hidden');
                        
                        showMessage(`‚úÖ Photo ${photoNum} uploaded!`, 'success');
                    } catch (error) {
                        console.error('Photo preview error:', error);
                        showMessage('‚ùå Photo preview failed.', 'error');
                    }
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Photo handling error:', error);
                showMessage('‚ùå Photo upload failed.', 'error');
            }
        }

        function removePhoto(photoNum) {
            try {
                photos[photoNum] = null;
                
                document.getElementById(`photo${photoNum}-preview`).classList.add('hidden');
                document.getElementById(`photo${photoNum}-input`).classList.remove('hidden');
                
                // Clear file inputs
                document.getElementById(`photo${photoNum}-camera`).value = '';
                document.getElementById(`photo${photoNum}-gallery`).value = '';
                
                showMessage(`‚úÖ Photo ${photoNum} removed.`, 'success');
            } catch (error) {
                console.error('Photo removal error:', error);
            }
        }

        // Safety Photo functions
        function handleSafetyPhoto(photoNum, event) {
            try {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    showSafetyMessage('‚ùå Photo too large. Max 5MB allowed.', 'error');
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showSafetyMessage('‚ùå Please select a valid image file.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        safetyPhotos[photoNum] = {
                            data: e.target.result,
                            name: file.name,
                            size: file.size
                        };
                        
                        // Show preview
                        document.getElementById(`safety-photo${photoNum}-img`).src = e.target.result;
                        document.getElementById(`safety-photo${photoNum}-name`).textContent = file.name;
                        document.getElementById(`safety-photo${photoNum}-preview`).classList.remove('hidden');
                        document.getElementById(`safety-photo${photoNum}-input`).classList.add('hidden');
                        
                        showSafetyMessage(`‚úÖ Safety photo ${photoNum} uploaded!`, 'success');
                    } catch (error) {
                        console.error('Safety photo preview error:', error);
                        showSafetyMessage('‚ùå Safety photo preview failed.', 'error');
                    }
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Safety photo handling error:', error);
                showSafetyMessage('‚ùå Safety photo upload failed.', 'error');
            }
        }

        function removeSafetyPhoto(photoNum) {
            try {
                safetyPhotos[photoNum] = null;
                
                document.getElementById(`safety-photo${photoNum}-preview`).classList.add('hidden');
                document.getElementById(`safety-photo${photoNum}-input`).classList.remove('hidden');
                
                // Clear file inputs
                document.getElementById(`safety-photo${photoNum}-camera`).value = '';
                document.getElementById(`safety-photo${photoNum}-gallery`).value = '';
                
                showSafetyMessage(`‚úÖ Safety photo ${photoNum} removed.`, 'success');
            } catch (error) {
                console.error('Safety photo removal error:', error);
            }
        }

        // QA/QC Photo functions
        function handleQAQCPhoto(photoNum, event) {
            try {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    showQualityMessage('‚ùå Photo too large. Max 5MB allowed.', 'error');
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showQualityMessage('‚ùå Please select a valid image file.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        qaqcPhotos[photoNum] = {
                            data: e.target.result,
                            name: file.name,
                            size: file.size
                        };
                        
                        // Show preview
                        document.getElementById(`qaqc-photo${photoNum}-img`).src = e.target.result;
                        document.getElementById(`qaqc-photo${photoNum}-name`).textContent = file.name;
                        document.getElementById(`qaqc-photo${photoNum}-preview`).classList.remove('hidden');
                        document.getElementById(`qaqc-photo${photoNum}-input`).classList.add('hidden');
                        
                        showQualityMessage(`‚úÖ QA/QC photo ${photoNum} uploaded!`, 'success');
                    } catch (error) {
                        console.error('QA/QC photo preview error:', error);
                        showQualityMessage('‚ùå QA/QC photo preview failed.', 'error');
                    }
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('QA/QC photo handling error:', error);
                showQualityMessage('‚ùå QA/QC photo upload failed.', 'error');
            }
        }

        function removeQAQCPhoto(photoNum) {
            try {
                qaqcPhotos[photoNum] = null;
                
                document.getElementById(`qaqc-photo${photoNum}-preview`).classList.add('hidden');
                document.getElementById(`qaqc-photo${photoNum}-input`).classList.remove('hidden');
                
                // Clear file inputs
                document.getElementById(`qaqc-photo${photoNum}-camera`).value = '';
                document.getElementById(`qaqc-photo${photoNum}-gallery`).value = '';
                
                showQualityMessage(`‚úÖ QA/QC photo ${photoNum} removed.`, 'success');
            } catch (error) {
                console.error('QA/QC photo removal error:', error);
            }
        }

        // Expandable Photo Functions
        function addMoreActivityPhotos() {
            if (activityPhotoSlots >= 6) {
                showMessage('‚ùå Maximum 6 photos allowed per activity.', 'error');
                return;
            }

            const container = document.getElementById('activity-photos-container');
            const newSlotNum = activityPhotoSlots + 1;
            
            // Create new photo slot
            const newPhotoSection = document.createElement('div');
            newPhotoSection.className = 'photo-section';
            newPhotoSection.style.width = '100%';
            newPhotoSection.style.marginBottom = '12px';
            
            newPhotoSection.innerHTML = `
                <label class="form-label">Activity Photo ${newSlotNum}</label>
                <div id="photo${newSlotNum}-preview" class="hidden">
                    <img id="photo${newSlotNum}-img" class="photo-preview">
                    <div class="photo-name" id="photo${newSlotNum}-name"></div>
                    <button onclick="removePhoto(${newSlotNum})" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                </div>
                <div id="photo${newSlotNum}-input">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                            üì∑ Camera
                            <input type="file" id="photo${newSlotNum}-camera" accept="image/*" capture="environment" style="display: none;">
                        </label>
                        <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                            üìÅ Gallery
                            <input type="file" id="photo${newSlotNum}-gallery" accept="image/*" style="display: none;">
                        </label>
                    </div>
                </div>
            `;
            
            container.appendChild(newPhotoSection);
            
            // Add event listeners for new photo inputs
            document.getElementById(`photo${newSlotNum}-camera`).addEventListener('change', (e) => handlePhoto(newSlotNum, e));
            document.getElementById(`photo${newSlotNum}-gallery`).addEventListener('change', (e) => handlePhoto(newSlotNum, e));
            
            activityPhotoSlots++;
            updatePhotoSlotDisplay('activity');
            
            showMessage(`‚úÖ Photo slot ${newSlotNum} added!`, 'success');
        }

        function addMoreSafetyPhotos() {
            if (safetyPhotoSlots >= 6) {
                showSafetyMessage('‚ùå Maximum 6 photos allowed per safety report.', 'error');
                return;
            }

            const container = document.getElementById('safety-photos-container');
            const newSlotNum = safetyPhotoSlots + 1;
            
            // Create new photo slot
            const newPhotoSection = document.createElement('div');
            newPhotoSection.className = 'photo-section';
            newPhotoSection.style.width = '100%';
            newPhotoSection.style.marginBottom = '12px';
            
            newPhotoSection.innerHTML = `
                <label class="form-label">Safety Photo ${newSlotNum}</label>
                <div id="safety-photo${newSlotNum}-preview" class="hidden">
                    <img id="safety-photo${newSlotNum}-img" class="photo-preview">
                    <div class="photo-name" id="safety-photo${newSlotNum}-name"></div>
                    <button onclick="removeSafetyPhoto(${newSlotNum})" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                </div>
                <div id="safety-photo${newSlotNum}-input">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                            üì∑ Camera
                            <input type="file" id="safety-photo${newSlotNum}-camera" accept="image/*" capture="environment" style="display: none;">
                        </label>
                        <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                            üìÅ Gallery
                            <input type="file" id="safety-photo${newSlotNum}-gallery" accept="image/*" style="display: none;">
                        </label>
                    </div>
                </div>
            `;
            
            container.appendChild(newPhotoSection);
            
            // Add event listeners for new photo inputs
            document.getElementById(`safety-photo${newSlotNum}-camera`).addEventListener('change', (e) => handleSafetyPhoto(newSlotNum, e));
            document.getElementById(`safety-photo${newSlotNum}-gallery`).addEventListener('change', (e) => handleSafetyPhoto(newSlotNum, e));
            
            safetyPhotoSlots++;
            updatePhotoSlotDisplay('safety');
            
            showSafetyMessage(`‚úÖ Photo slot ${newSlotNum} added!`, 'success');
        }

        function addMoreQAQCPhotos() {
            if (qaqcPhotoSlots >= 6) {
                showQualityMessage('‚ùå Maximum 6 photos allowed per QA/QC report.', 'error');
                return;
            }

            const container = document.getElementById('qaqc-photos-container');
            const newSlotNum = qaqcPhotoSlots + 1;
            
            // Create new photo slot
            const newPhotoSection = document.createElement('div');
            newPhotoSection.className = 'photo-section';
            newPhotoSection.style.width = '100%';
            newPhotoSection.style.marginBottom = '12px';
            
            newPhotoSection.innerHTML = `
                <label class="form-label">QA/QC Photo ${newSlotNum}</label>
                <div id="qaqc-photo${newSlotNum}-preview" class="hidden">
                    <img id="qaqc-photo${newSlotNum}-img" class="photo-preview">
                    <div class="photo-name" id="qaqc-photo${newSlotNum}-name"></div>
                    <button onclick="removeQAQCPhoto(${newSlotNum})" class="btn btn-danger" style="width: auto; padding: 8px 12px; font-size: 12px;">Remove</button>
                </div>
                <div id="qaqc-photo${newSlotNum}-input">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <label class="btn btn-primary" style="font-size: 12px; padding: 10px;">
                            üì∑ Camera
                            <input type="file" id="qaqc-photo${newSlotNum}-camera" accept="image/*" capture="environment" style="display: none;">
                        </label>
                        <label class="btn" style="background: #6b7280; color: white; font-size: 12px; padding: 10px;">
                            üìÅ Gallery
                            <input type="file" id="qaqc-photo${newSlotNum}-gallery" accept="image/*" style="display: none;">
                        </label>
                    </div>
                </div>
            `;
            
            container.appendChild(newPhotoSection);
            
            // Add event listeners for new photo inputs
            document.getElementById(`qaqc-photo${newSlotNum}-camera`).addEventListener('change', (e) => handleQAQCPhoto(newSlotNum, e));
            document.getElementById(`qaqc-photo${newSlotNum}-gallery`).addEventListener('change', (e) => handleQAQCPhoto(newSlotNum, e));
            
            qaqcPhotoSlots++;
            updatePhotoSlotDisplay('qaqc');
            
            showQualityMessage(`‚úÖ Photo slot ${newSlotNum} added!`, 'success');
        }

        function updatePhotoSlotDisplay(type) {
            try {
                let currentSlots, maxSlots;
                
                if (type === 'activity') {
                    currentSlots = activityPhotoSlots;
                    document.getElementById('activity-photo-count').textContent = currentSlots;
                    if (currentSlots >= 6) {
                        document.getElementById('add-activity-photos-btn').style.display = 'none';
                    }
                } else if (type === 'safety') {
                    currentSlots = safetyPhotoSlots;
                    document.getElementById('safety-photo-count').textContent = currentSlots;
                    if (currentSlots >= 6) {
                        document.getElementById('add-safety-photos-btn').style.display = 'none';
                    }
                } else if (type === 'qaqc') {
                    currentSlots = qaqcPhotoSlots;
                    document.getElementById('qaqc-photo-count').textContent = currentSlots;
                    if (currentSlots >= 6) {
                        document.getElementById('add-qaqc-photos-btn').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Update photo slot display error:', error);
            }
        }

        // Add activity
        function addActivity() {
            try {
                const startTime = document.getElementById('start-time').value;
                const location = document.getElementById('location').value;
                const contractor = document.getElementById('contractor').value;
                const workCategory = document.getElementById('work-category').value;
                
                if (!startTime || !location || !contractor || !workCategory) {
                    showMessage('‚ùå Please fill in Start Time, Location, Contractor, and Work Category', 'error');
                    return;
                }

                const activity = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    startTime: startTime,
                    endTime: document.getElementById('end-time').value || '',
                    location: location,
                    specificArea: document.getElementById('specific-area').value || '',
                    locationDetails: document.getElementById('location-details').value || '',
                    contractor: contractor,
                    workCategory: workCategory,
                    workType: document.getElementById('work-type').value || '',
                    workDescription: document.getElementById('work-description').value || '',
                    workStatus: document.getElementById('work-status').value || '',
                    qualityStatus: document.getElementById('quality-status').value || '',
                    workerCount: document.getElementById('worker-count').value || '',
                    supervisorCount: document.getElementById('supervisor-count').value || '',
                    specialistCount: document.getElementById('specialist-count').value || '',
                    equipment: [...activityEquipment],
                    materials: [...activityMaterials],
                    activitySafetyRemarks: document.getElementById('activity-safety-remarks').value || '',
                    activityGeneralRemarks: document.getElementById('activity-general-remarks').value || '',
                    photos: JSON.parse(JSON.stringify(photos))
                };

                dailyActivities.push(activity);
                clearActivityForm();
                updateAllDisplays();
                autoSave();
                
                showMessage('‚úÖ Activity added successfully!', 'success');
                
            } catch (error) {
                console.error('Add activity error:', error);
                showMessage('‚ùå Failed to add activity.', 'error');
            }
        }

        // Add safety status
        function addSafetyStatus() {
            try {
                const safetyStatus = document.getElementById('safety-status').value;
                const safetyOfficer = document.getElementById('safety-officer').value;
                const ppeCompliance = document.getElementById('ppe-compliance').value;
                
                if (!safetyStatus || !safetyOfficer || !ppeCompliance) {
                    showSafetyMessage('‚ùå Please fill in Safety Status, Safety Officer, and PPE Compliance', 'error');
                    return;
                }

                const safetyReport = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    // Section 1: Overall Safety Performance
                    safetyStatus: safetyStatus,
                    safetyOfficer: safetyOfficer,
                    ppeCompliance: ppeCompliance,
                    safetyObservations: document.getElementById('safety-observations').value || '',
                    linkedActivity: document.getElementById('linked-activity').value || '',
                    // Section 2: Near-Miss Issues
                    nearMissRecord: document.getElementById('near-miss-record').value || '',
                    nearMissRange: document.getElementById('near-miss-range').value || '',
                    correctiveActions: document.getElementById('corrective-actions').value || '',
                    safetyPhotos: JSON.parse(JSON.stringify(safetyPhotos))
                };

                dailySafetyReports.push(safetyReport);
                clearSafetyForm();
                updateAllDisplays();
                autoSave();
                
                showSafetyMessage('‚úÖ Safety status added to report!', 'success');
                
            } catch (error) {
                console.error('Add safety status error:', error);
                showSafetyMessage('‚ùå Failed to add safety status.', 'error');
            }
        }

        // Add progress report
        function addProgress() {
            try {
                const progressRating = document.getElementById('progress-rating').value;
                const keyAchievements = document.getElementById('key-achievements').value;
                
                if (!progressRating) {
                    showProgressMessage('‚ùå Please select a Progress Rating', 'error');
                    return;
                }

                const progressReport = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    progressRating: progressRating,
                    keyAchievements: keyAchievements || '',
                    issuesChallenges: document.getElementById('issues-challenges').value || '',
                    tomorrowPlan: document.getElementById('tomorrow-plan').value || ''
                };

                dailyProgressReports.push(progressReport);
                clearProgressForm();
                updateAllDisplays();
                autoSave();
                
                showProgressMessage('‚úÖ Progress report added!', 'success');
                
            } catch (error) {
                console.error('Add progress error:', error);
                showProgressMessage('‚ùå Failed to add progress report.', 'error');
            }
        }

        // Add quality control report
        function addQualityControl() {
            try {
                const overallQuality = document.getElementById('overall-quality').value;
                const reworkRequired = document.getElementById('rework-required').value;
                
                if (!overallQuality || !reworkRequired) {
                    showQualityMessage('‚ùå Please select Overall Quality and Rework Required', 'error');
                    return;
                }

                const qualityReport = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    overallQuality: overallQuality,
                    reworkRequired: reworkRequired,
                    qualityIssues: document.getElementById('quality-issues').value || '',
                    qaqcPhotos: JSON.parse(JSON.stringify(qaqcPhotos))
                };

                dailyQualityReports.push(qualityReport);
                clearQualityForm();
                updateAllDisplays();
                autoSave();
                
                showQualityMessage('‚úÖ QA/QC report added!', 'success');
                
            } catch (error) {
                console.error('Add quality control error:', error);
                showQualityMessage('‚ùå Failed to add QA/QC report.', 'error');
            }
        }

        // Clear forms
        function clearActivityForm() {
            try {
                const formFields = [
                    'end-time', 'location', 'specific-area', 'location-details',
                    'contractor', 'work-category', 'work-type', 'work-description',
                    'work-status', 'quality-status', 'worker-count', 'supervisor-count',
                    'specialist-count', 'activity-safety-remarks', 'activity-general-remarks'
                ];
                
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
                
                // Clear photos
                for (let i = 1; i <= activityPhotoSlots; i++) {
                    removePhoto(i);
                }
                
                // Clear equipment and materials
                activityEquipment = [];
                activityMaterials = [];
                updateEquipmentDisplay();
                updateMaterialsDisplay();
                
                // Reset work types
                document.getElementById('work-type').innerHTML = '<option value="">Select Work Type</option>';
                document.getElementById('work-type').disabled = true;
                
                // Reset photo slots to default
                resetPhotoSlots('activity');
                
                // Update start time
                setCurrentTime();
                
            } catch (error) {
                console.error('Form clearing error:', error);
            }
        }

        function clearSafetyForm() {
            try {
                const formFields = [
                    'safety-status', 'safety-officer', 'ppe-compliance', 
                    'safety-observations', 'linked-activity',
                    'near-miss-record', 'near-miss-range', 'corrective-actions'
                ];
                
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
                
                // Clear safety photos
                for (let i = 1; i <= safetyPhotoSlots; i++) {
                    removeSafetyPhoto(i);
                }
                
                // Reset photo slots to default
                resetPhotoSlots('safety');
            } catch (error) {
                console.error('Safety form clearing error:', error);
            }
        }

        function clearProgressForm() {
            try {
                const formFields = [
                    'progress-rating', 'key-achievements', 'issues-challenges', 'tomorrow-plan'
                ];
                
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
            } catch (error) {
                console.error('Progress form clearing error:', error);
            }
        }

        function clearQualityForm() {
            try {
                const formFields = [
                    'overall-quality', 'rework-required', 'quality-issues'
                ];
                
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
                
                // Clear QA/QC photos
                for (let i = 1; i <= qaqcPhotoSlots; i++) {
                    removeQAQCPhoto(i);
                }
                
                // Reset photo slots to default
                resetPhotoSlots('qaqc');
            } catch (error) {
                console.error('Quality form clearing error:', error);
            }
        }

        function resetPhotoSlots(type) {
            try {
                if (type === 'activity') {
                    // Remove extra photo slots beyond the default 2
                    const container = document.getElementById('activity-photos-container');
                    const children = container.children;
                    while (children.length > 1) { // Keep only the first row (default 2 photos)
                        container.removeChild(children[children.length - 1]);
                    }
                    activityPhotoSlots = 2;
                    document.getElementById('add-activity-photos-btn').style.display = 'inline-flex';
                    updatePhotoSlotDisplay('activity');
                } else if (type === 'safety') {
                    const container = document.getElementById('safety-photos-container');
                    const children = container.children;
                    while (children.length > 1) {
                        container.removeChild(children[children.length - 1]);
                    }
                    safetyPhotoSlots = 2;
                    document.getElementById('add-safety-photos-btn').style.display = 'inline-flex';
                    updatePhotoSlotDisplay('safety');
                } else if (type === 'qaqc') {
                    const container = document.getElementById('qaqc-photos-container');
                    const children = container.children;
                    while (children.length > 1) {
                        container.removeChild(children[children.length - 1]);
                    }
                    qaqcPhotoSlots = 2;
                    document.getElementById('add-qaqc-photos-btn').style.display = 'inline-flex';
                    updatePhotoSlotDisplay('qaqc');
                }
            } catch (error) {
                console.error('Reset photo slots error:', error);
            }
        }

        // Update all displays
        function updateAllDisplays() {
            updateActivityDisplay();
            updateSafetyDisplay();
            updateProgressDisplay();
            updateQualityDisplay();
            updateSummaryStats();
            updateLinkedActivities();
        }

        // Display functions
        function updateActivityDisplay() {
            try {
                document.getElementById('activity-count').textContent = dailyActivities.length;
                document.getElementById('activities-count').textContent = dailyActivities.length;
                
                const activitiesReport = document.getElementById('activities-report');
                
                if (dailyActivities.length === 0) {
                    activitiesReport.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            No activities recorded yet
                        </div>
                    `;
                } else {
                    activitiesReport.innerHTML = dailyActivities.map((activity, index) => `
                        <div class="report-item">
                            <div class="report-item-header">
                                <div><strong>Activity #${index + 1}</strong></div>
                                <div class="report-timestamp">${activity.startTime}${activity.endTime ? ' - ' + activity.endTime : ''}</div>
                            </div>
                            <div>
                                <div><strong>üìç Location:</strong> ${activity.location}${activity.specificArea ? ' - ' + activity.specificArea : ''}</div>
                                <div><strong>üë∑ Contractor:</strong> ${activity.contractor}</div>
                                <div><strong>üîß Work:</strong> ${activity.workCategory}${activity.workType ? ' - ' + activity.workType : ''}</div>
                                ${activity.workDescription ? `<div><strong>üìù Description:</strong> ${activity.workDescription}</div>` : ''}
                                ${activity.workerCount ? `<div><strong>üë• Workers:</strong> ${activity.workerCount}</div>` : ''}
                                ${getEquipmentHTML(activity.equipment)}
                                ${getMaterialsHTML(activity.materials)}
                                ${activity.workStatus ? `<div><strong>üìä Status:</strong> ${activity.workStatus}</div>` : ''}
                                ${getActivityPhotosHTML(activity.photos)}
                                <button class="delete-btn" onclick="deleteActivity(${index})" style="margin-top: 8px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Activity display error:', error);
            }
        }

        function updateSafetyDisplay() {
            try {
                document.getElementById('safety-count').textContent = dailySafetyReports.length;
                
                const safetyReports = document.getElementById('safety-reports');
                
                if (dailySafetyReports.length === 0) {
                    safetyReports.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            No safety reports added yet
                        </div>
                    `;
                } else {
                    safetyReports.innerHTML = dailySafetyReports.map((report, index) => `
                        <div class="report-item">
                            <div class="report-item-header">
                                <div><strong>Safety Report #${index + 1}</strong></div>
                                <div class="report-timestamp">${report.timestamp}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">Section 1: Overall Safety Performance</div>
                                <div><strong>üõ°Ô∏è Status:</strong> ${report.safetyStatus}</div>
                                <div><strong>üëÆ Officer:</strong> ${report.safetyOfficer}</div>
                                <div><strong>ü¶∫ PPE:</strong> ${report.ppeCompliance}</div>
                                ${report.safetyObservations ? `<div><strong>üìù Observations:</strong> ${report.safetyObservations}</div>` : ''}
                                ${report.linkedActivity ? `<div><strong>üîó Linked Activity:</strong> ${report.linkedActivity}</div>` : ''}
                                
                                ${report.nearMissRecord || report.nearMissRange || report.correctiveActions ? `
                                    <div style="font-weight: 600; color: #dc2626; margin: 12px 0 8px 0;">Section 2: Near-Miss Issues</div>
                                    ${report.nearMissRecord ? `<div><strong>‚ö†Ô∏è Near-Miss Record:</strong> ${report.nearMissRecord}</div>` : ''}
                                    ${report.nearMissRange ? `<div><strong>üéØ Risk Level:</strong> ${report.nearMissRange}</div>` : ''}
                                    ${report.correctiveActions ? `<div><strong>üîß Corrective Actions:</strong> ${report.correctiveActions}</div>` : ''}
                                ` : ''}
                                
                                ${getSafetyPhotosHTML(report.safetyPhotos)}
                                <button class="delete-btn" onclick="deleteSafetyReport(${index})" style="margin-top: 8px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Safety display error:', error);
            }
        }

        function updateProgressDisplay() {
            try {
                document.getElementById('progress-count').textContent = dailyProgressReports.length;
                
                const progressReports = document.getElementById('progress-reports');
                
                if (dailyProgressReports.length === 0) {
                    progressReports.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            No progress reports added yet
                        </div>
                    `;
                } else {
                    progressReports.innerHTML = dailyProgressReports.map((report, index) => `
                        <div class="report-item">
                            <div class="report-item-header">
                                <div><strong>Progress Report #${index + 1}</strong></div>
                                <div class="report-timestamp">${report.timestamp}</div>
                            </div>
                            <div>
                                <div><strong>üìà Rating:</strong> ${report.progressRating}</div>
                                ${report.keyAchievements ? `<div><strong>üéØ Achievements:</strong> ${report.keyAchievements}</div>` : ''}
                                ${report.issuesChallenges ? `<div><strong>‚ö†Ô∏è Issues:</strong> ${report.issuesChallenges}</div>` : ''}
                                ${report.tomorrowPlan ? `<div><strong>üìÖ Tomorrow:</strong> ${report.tomorrowPlan}</div>` : ''}
                                <button class="delete-btn" onclick="deleteProgressReport(${index})" style="margin-top: 8px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Progress display error:', error);
            }
        }

        function updateQualityDisplay() {
            try {
                document.getElementById('quality-count').textContent = dailyQualityReports.length;
                
                const qualityReports = document.getElementById('quality-reports');
                
                if (dailyQualityReports.length === 0) {
                    qualityReports.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            No QA/QC reports added yet
                        </div>
                    `;
                } else {
                    qualityReports.innerHTML = dailyQualityReports.map((report, index) => `
                        <div class="report-item">
                            <div class="report-item-header">
                                <div><strong>QA/QC Report #${index + 1}</strong></div>
                                <div class="report-timestamp">${report.timestamp}</div>
                            </div>
                            <div>
                                <div><strong>üîç Quality:</strong> ${report.overallQuality}</div>
                                <div><strong>üîÑ Rework:</strong> ${report.reworkRequired}</div>
                                ${report.qualityIssues ? `<div><strong>üìù Issues:</strong> ${report.qualityIssues}</div>` : ''}
                                ${getQAQCPhotosHTML(report.qaqcPhotos)}
                                <button class="delete-btn" onclick="deleteQualityReport(${index})" style="margin-top: 8px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Quality display error:', error);
            }
        }

        // Helper functions for display
        function getEquipmentHTML(equipment) {
            if (!equipment || equipment.length === 0) return '';
            
            const equipmentText = equipment.map(item => `${item.quantity}x ${item.equipment}`).join(', ');
            return `<div><strong>üîß Equipment:</strong> ${equipmentText}</div>`;
        }

        function getMaterialsHTML(materials) {
            if (!materials || materials.length === 0) return '';
            
            const materialsText = materials.map(item => `${item.material} (${item.details})`).join(', ');
            return `<div><strong>üì¶ Materials:</strong> ${materialsText}</div>`;
        }

        // Get photos HTML for display
        function getActivityPhotosHTML(activityPhotos) {
            try {
                const photoElements = [];
                for (let i = 1; i <= 6; i++) {
                    if (activityPhotos && activityPhotos[i] && activityPhotos[i].data) {
                        photoElements.push(`<img src="${activityPhotos[i].data}" alt="Photo ${i}" class="activity-photo">`);
                    }
                }
                
                if (photoElements.length > 0) {
                    return `<div class="activity-photos">${photoElements.join('')}</div>`;
                }
                return '';
            } catch (error) {
                console.error('Activity photos HTML error:', error);
                return '';
            }
        }

        function getSafetyPhotosHTML(safetyPhotos) {
            try {
                const photoElements = [];
                for (let i = 1; i <= 6; i++) {
                    if (safetyPhotos && safetyPhotos[i] && safetyPhotos[i].data) {
                        photoElements.push(`<img src="${safetyPhotos[i].data}" alt="Safety Photo ${i}" class="activity-photo">`);
                    }
                }
                
                if (photoElements.length > 0) {
                    return `<div class="activity-photos">${photoElements.join('')}</div>`;
                }
                return '';
            } catch (error) {
                console.error('Safety photos HTML error:', error);
                return '';
            }
        }

        function getQAQCPhotosHTML(qaqcPhotos) {
            try {
                const photoElements = [];
                for (let i = 1; i <= 6; i++) {
                    if (qaqcPhotos && qaqcPhotos[i] && qaqcPhotos[i].data) {
                        photoElements.push(`<img src="${qaqcPhotos[i].data}" alt="QA/QC Photo ${i}" class="activity-photo">`);
                    }
                }
                
                if (photoElements.length > 0) {
                    return `<div class="activity-photos">${photoElements.join('')}</div>`;
                }
                return '';
            } catch (error) {
                console.error('QA/QC photos HTML error:', error);
                return '';
            }
        }

        // Delete functions
        function deleteActivity(index) {
            try {
                if (confirm('‚ùå Delete this activity?')) {
                    dailyActivities.splice(index, 1);
                    updateAllDisplays();
                    autoSave();
                    showMessage('‚úÖ Activity deleted.', 'success');
                }
            } catch (error) {
                console.error('Delete activity error:', error);
            }
        }

        function deleteSafetyReport(index) {
            try {
                if (confirm('‚ùå Delete this safety report?')) {
                    dailySafetyReports.splice(index, 1);
                    updateAllDisplays();
                    autoSave();
                    showSafetyMessage('‚úÖ Safety report deleted.', 'success');
                }
            } catch (error) {
                console.error('Delete safety report error:', error);
            }
        }

        function deleteProgressReport(index) {
            try {
                if (confirm('‚ùå Delete this progress report?')) {
                    dailyProgressReports.splice(index, 1);
                    updateAllDisplays();
                    autoSave();
                    showProgressMessage('‚úÖ Progress report deleted.', 'success');
                }
            } catch (error) {
                console.error('Delete progress report error:', error);
            }
        }

        function deleteQualityReport(index) {
            try {
                if (confirm('‚ùå Delete this QA/QC report?')) {
                    dailyQualityReports.splice(index, 1);
                    updateAllDisplays();
                    autoSave();
                    showQualityMessage('‚úÖ QA/QC report deleted.', 'success');
                }
            } catch (error) {
                console.error('Delete quality report error:', error);
            }
        }

        // Update linked activities dropdown
        function updateLinkedActivities() {
            try {
                const linkedSelect = document.getElementById('linked-activity');
                linkedSelect.innerHTML = '<option value="">Select Activity</option>';
                
                dailyActivities.forEach((activity, index) => {
                    const option = document.createElement('option');
                    option.value = activity.id;
                    option.textContent = `Activity #${index + 1} - ${activity.startTime} - ${activity.workCategory}`;
                    linkedSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Update linked activities error:', error);
            }
        }

        // Delivery Modal functions
        function deliverReport() {
            try {
                const hasData = dailyActivities.length > 0 || dailySafetyReports.length > 0 || 
                               dailyProgressReports.length > 0 || dailyQualityReports.length > 0;
                               
                if (!hasData) {
                    showMessage('‚ùå No data to deliver. Add some activities or reports first.', 'error');
                    return;
                }

                // Update modal content
                document.getElementById('modal-activities').textContent = dailyActivities.length;
                document.getElementById('modal-safety').textContent = dailySafetyReports.length;
                document.getElementById('modal-progress').textContent = dailyProgressReports.length;
                document.getElementById('modal-quality').textContent = dailyQualityReports.length;

                const totalWorkers = dailyActivities.reduce((sum, activity) => {
                    return sum + (parseInt(activity.workerCount) || 0) + (parseInt(activity.supervisorCount) || 0) + (parseInt(activity.specialistCount) || 0);
                }, 0);
                document.getElementById('modal-workers').textContent = totalWorkers;

                const activeContractors = [...new Set(dailyActivities.map(a => a.contractor).filter(c => c))].length;
                document.getElementById('modal-contractors').textContent = activeContractors;

                document.getElementById('modal-date').textContent = new Date().toLocaleDateString();

                // Show modal
                document.getElementById('delivery-modal').classList.add('show');
            } catch (error) {
                console.error('Deliver report error:', error);
                showMessage('‚ùå Failed to prepare delivery.', 'error');
            }
        }

        function closeDeliveryModal() {
            document.getElementById('delivery-modal').classList.remove('show');
        }

        function confirmDelivery() {
            try {
                // Mark report as delivered
                isReportDelivered = true;

                // Update UI
                document.getElementById('status-bar').classList.add('delivered');
                document.getElementById('report-title').innerHTML = 'üìã Report Delivered';
                document.getElementById('report-status').textContent = '‚úÖ Delivered';

                // Enable export buttons
                document.getElementById('download-csv-btn').disabled = false;
                document.getElementById('sync-btn').disabled = false;
                document.getElementById('deliver-btn').disabled = true;
                document.getElementById('deliver-text').textContent = '‚úÖ Report Delivered';

                document.getElementById('export-status').textContent = 'Report delivered - Ready to export';

                // Close modal
                closeDeliveryModal();

                // Auto-save delivered status
                autoSave();

                showMessage('‚úÖ Report delivered successfully! You can now export.', 'success');
            } catch (error) {
                console.error('Confirm delivery error:', error);
                showMessage('‚ùå Failed to deliver report.', 'error');
            }
        }

        // Update summary statistics
        function updateSummaryStats() {
            try {
                const totalActivities = dailyActivities.length;
                const totalSafetyReports = dailySafetyReports.length;
                const totalProgressReports = dailyProgressReports.length;
                const totalQualityReports = dailyQualityReports.length;
                const totalReports = totalActivities + totalSafetyReports + totalProgressReports + totalQualityReports;
                
                const totalWorkers = dailyActivities.reduce((sum, activity) => {
                    return sum + (parseInt(activity.workerCount) || 0) + (parseInt(activity.supervisorCount) || 0) + (parseInt(activity.specialistCount) || 0);
                }, 0);
                const activeContractors = [...new Set(dailyActivities.map(a => a.contractor).filter(c => c))].length;
                
                // Calculate work hours
                let totalHours = 0;
                dailyActivities.forEach(activity => {
                    if (activity.startTime && activity.endTime) {
                        const start = new Date(`2000-01-01T${activity.startTime}`);
                        const end = new Date(`2000-01-01T${activity.endTime}`);
                        const hours = (end - start) / (1000 * 60 * 60);
                        if (hours > 0) totalHours += hours;
                    }
                });
                
                // Update display
                document.getElementById('total-activities').textContent = totalActivities;
                document.getElementById('total-reports').textContent = totalReports;
                document.getElementById('total-workers').textContent = totalWorkers;
                document.getElementById('active-contractors').textContent = activeContractors;
                document.getElementById('work-hours').textContent = Math.round(totalHours * 10) / 10;
                
                // Update buttons based on delivery status
                const hasData = totalReports > 0;
                document.getElementById('deliver-btn').disabled = !hasData || isReportDelivered;
                document.getElementById('download-csv-btn').disabled = !isReportDelivered;
                document.getElementById('sync-btn').disabled = !isReportDelivered;
                
                if (isReportDelivered) {
                    document.getElementById('export-status').textContent = 'Report delivered - Ready to export';
                } else if (hasData) {
                    document.getElementById('export-status').textContent = 'Deliver report first to enable export';
                } else {
                    document.getElementById('export-status').textContent = 'Add data to enable delivery';
                }
                
                // Update report status
                if (isReportDelivered) {
                    document.getElementById('report-status').textContent = '‚úÖ Delivered';
                } else {
                    document.getElementById('report-status').textContent = 
                        totalReports === 0 ? 'üü° In Progress' : 
                        totalReports < 5 ? 'üü† Partial' : 'üü¢ Ready';
                }
                
            } catch (error) {
                console.error('Summary stats update error:', error);
            }
        }

        // Update connection status
        function updateConnectionStatus() {
            const dot = document.getElementById('connection-dot');
            const syncStatus = document.getElementById('sync-status');
            
            if (window.isOnline && window.firebase.db) {
                dot.classList.remove('offline');
                syncStatus.textContent = 'Online';
            } else {
                dot.classList.add('offline');
                syncStatus.textContent = 'Offline';
            }
        }

        // Show messages for different tabs
        function showMessage(message, type) {
            try {
                const messageDiv = document.getElementById('activity-message');
                if (messageDiv) {
                    messageDiv.className = type === 'success' ? 'message success' : 'message error';
                    messageDiv.textContent = message;
                    
                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 4000);
                }
            } catch (error) {
                console.error('Message display error:', error);
            }
        }

        function showSafetyMessage(message, type) {
            try {
                const messageDiv = document.getElementById('safety-message');
                if (messageDiv) {
                    messageDiv.className = type === 'success' ? 'message success' : 'message error';
                    messageDiv.textContent = message;
                    
                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 4000);
                }
            } catch (error) {
                console.error('Safety message display error:', error);
            }
        }

        function showProgressMessage(message, type) {
            try {
                const messageDiv = document.getElementById('progress-message');
                if (messageDiv) {
                    messageDiv.className = type === 'success' ? 'message success' : 'message error';
                    messageDiv.textContent = message;
                    
                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 4000);
                }
            } catch (error) {
                console.error('Progress message display error:', error);
            }
        }

        function showQualityMessage(message, type) {
            try {
                const messageDiv = document.getElementById('quality-message');
                if (messageDiv) {
                    messageDiv.className = type === 'success' ? 'message success' : 'message error';
                    messageDiv.textContent = message;
                    
                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 4000);
                }
            } catch (error) {
                console.error('Quality message display error:', error);
            }
        }

        // Generate CSV - Enhanced with photos
        function generateCSV() {
            try {
                let csvContent = '';
                const today = new Date().toLocaleDateString();
                const projectSelect = document.getElementById('project-name').value;
                const customProject = document.getElementById('custom-project-name').value;
                const finalProject = projectSelect === 'Others' ? customProject : projectSelect;
                const reportedBy = document.getElementById('reported-by').value || '';
                const weather = document.getElementById('weather').value || '';
                const siteConditions = document.getElementById('site-conditions').value || '';

                // Header Information
                csvContent += `Daily Site Report - ${finalProject || 'Project'}\n`;
                csvContent += `Date: ${today}\n`;
                csvContent += `Reported By: ${reportedBy}\n`;
                csvContent += `Weather: ${weather}\n`;
                csvContent += `Site Conditions: ${siteConditions}\n`;
                csvContent += `Report Status: ${isReportDelivered ? 'DELIVERED' : 'DRAFT'}\n\n`;

                // Activities Section
                if (dailyActivities.length > 0) {
                    csvContent += `DAILY ACTIVITIES\n`;
                    const activityHeaders = [
                        'Start Time', 'End Time', 'Location', 'Area', 'Location Details',
                        'Contractor', 'Work Category', 'Work Type', 'Description', 'Status', 'Quality',
                        'Workers', 'Supervisors', 'Specialists', 'Equipment', 'Materials',
                        'Safety Remarks', 'General Remarks', 'Activity Photos', 'Timestamp'
                    ];
                    csvContent += activityHeaders.join(',') + '\n';
                    
                    dailyActivities.forEach(activity => {
                        const equipmentText = activity.equipment ? activity.equipment.map(e => `${e.quantity}x ${e.equipment}`).join('; ') : '';
                        const materialsText = activity.materials ? activity.materials.map(m => `${m.material} (${m.details})`).join('; ') : '';
                        const activityPhotos = [];
                        for (let i = 1; i <= 6; i++) {
                            if (activity.photos && activity.photos[i] && activity.photos[i].name) {
                                activityPhotos.push(activity.photos[i].name);
                            }
                        }
                        
                        const row = [
                            activity.startTime || '',
                            activity.endTime || '',
                            `"${activity.location || ''}"`,
                            `"${activity.specificArea || ''}"`,
                            `"${activity.locationDetails || ''}"`,
                            `"${activity.contractor || ''}"`,
                            `"${activity.workCategory || ''}"`,
                            `"${activity.workType || ''}"`,
                            `"${(activity.workDescription || '').replace(/"/g, '""')}"`,
                            `"${activity.workStatus || ''}"`,
                            `"${activity.qualityStatus || ''}"`,
                            activity.workerCount || '',
                            activity.supervisorCount || '',
                            activity.specialistCount || '',
                            `"${equipmentText}"`,
                            `"${materialsText}"`,
                            `"${(activity.activitySafetyRemarks || '').replace(/"/g, '""')}"`,
                            `"${(activity.activityGeneralRemarks || '').replace(/"/g, '""')}"`,
                            `"${activityPhotos.join('; ')}"`,
                            `"${activity.timestamp || ''}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                    csvContent += '\n';
                }

                // Safety Reports Section
                if (dailySafetyReports.length > 0) {
                    csvContent += `SAFETY REPORTS\n`;
                    const safetyHeaders = [
                        'Safety Status', 'Safety Officer', 'PPE Compliance', 'Safety Observations', 'Linked Activity',
                        'Near-Miss Record', 'Near-Miss Risk Level', 'Corrective Actions', 'Safety Photos', 'Timestamp'
                    ];
                    csvContent += safetyHeaders.join(',') + '\n';
                    
                    dailySafetyReports.forEach(safety => {
                        const safetyPhotosList = [];
                        for (let i = 1; i <= 6; i++) {
                            if (safety.safetyPhotos && safety.safetyPhotos[i] && safety.safetyPhotos[i].name) {
                                safetyPhotosList.push(safety.safetyPhotos[i].name);
                            }
                        }
                        
                        const row = [
                            `"${safety.safetyStatus || ''}"`,
                            `"${safety.safetyOfficer || ''}"`,
                            `"${safety.ppeCompliance || ''}"`,
                            `"${(safety.safetyObservations || '').replace(/"/g, '""')}"`,
                            `"${safety.linkedActivity || ''}"`,
                            `"${(safety.nearMissRecord || '').replace(/"/g, '""')}"`,
                            `"${safety.nearMissRange || ''}"`,
                            `"${(safety.correctiveActions || '').replace(/"/g, '""')}"`,
                            `"${safetyPhotosList.join('; ')}"`,
                            `"${safety.timestamp || ''}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                    csvContent += '\n';
                }

                // Progress Reports Section
                if (dailyProgressReports.length > 0) {
                    csvContent += `PROGRESS REPORTS\n`;
                    const progressHeaders = [
                        'Progress Rating', 'Key Achievements', 'Issues & Challenges', 
                        'Tomorrow Plan', 'Timestamp'
                    ];
                    csvContent += progressHeaders.join(',') + '\n';
                    
                    dailyProgressReports.forEach(progress => {
                        const row = [
                            `"${progress.progressRating || ''}"`,
                            `"${(progress.keyAchievements || '').replace(/"/g, '""')}"`,
                            `"${(progress.issuesChallenges || '').replace(/"/g, '""')}"`,
                            `"${(progress.tomorrowPlan || '').replace(/"/g, '""')}"`,
                            `"${progress.timestamp || ''}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                    csvContent += '\n';
                }

                // QA/QC Reports Section
                if (dailyQualityReports.length > 0) {
                    csvContent += `QA/QC REPORTS\n`;
                    const qualityHeaders = [
                        'Overall Quality', 'Rework Required', 'Quality Issues', 'QA/QC Photos', 'Timestamp'
                    ];
                    csvContent += qualityHeaders.join(',') + '\n';
                    
                    dailyQualityReports.forEach(quality => {
                        const qaqcPhotosList = [];
                        for (let i = 1; i <= 6; i++) {
                            if (quality.qaqcPhotos && quality.qaqcPhotos[i] && quality.qaqcPhotos[i].name) {
                                qaqcPhotosList.push(quality.qaqcPhotos[i].name);
                            }
                        }
                        
                        const row = [
                            `"${quality.overallQuality || ''}"`,
                            `"${quality.reworkRequired || ''}"`,
                            `"${(quality.qualityIssues || '').replace(/"/g, '""')}"`,
                            `"${qaqcPhotosList.join('; ')}"`,
                            `"${quality.timestamp || ''}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                    csvContent += '\n';
                }

                // Summary Section
                csvContent += `SUMMARY\n`;
                csvContent += `Total Activities: ${dailyActivities.length}\n`;
                csvContent += `Safety Reports: ${dailySafetyReports.length}\n`;
                csvContent += `Progress Reports: ${dailyProgressReports.length}\n`;
                csvContent += `QA/QC Reports: ${dailyQualityReports.length}\n`;
                csvContent += `Report Status: ${isReportDelivered ? 'DELIVERED' : 'DRAFT'}\n`;
                csvContent += `Report Generated: ${new Date().toLocaleString()}\n`;
                
                return csvContent;
            } catch (error) {
                console.error('CSV generation error:', error);
                throw new Error('Failed to generate CSV');
            }
        }

        // Download CSV
        function downloadCSV() {
            try {
                if (!isReportDelivered) {
                    showMessage('‚ùå Please deliver the report first before downloading.', 'error');
                    return;
                }
                
                // Show loading
                document.getElementById('csv-loading').classList.remove('hidden');
                document.getElementById('csv-text').textContent = 'Generating...';
                
                setTimeout(() => {
                    try {
                        const csvContent = generateCSV();
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        
                        const today = new Date().toISOString().split('T')[0];
                        const projectSelect = document.getElementById('project-name').value;
                        const customProject = document.getElementById('custom-project-name').value;
                        const finalProject = projectSelect === 'Others' ? customProject : projectSelect;
                        const projectName = (finalProject || 'Project').replace(/\s+/g, '_');
                        
                        const fileName = `Daily_Site_Report_${projectName}_${today}_DELIVERED.csv`;
                        
                        link.setAttribute('href', url);
                        link.setAttribute('download', fileName);
                        link.style.visibility = 'hidden';
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                        
                        showMessage('‚úÖ CSV downloaded! Share it via your phone.', 'success');
                    } catch (error) {
                        console.error('CSV download error:', error);
                        showMessage('‚ùå CSV export failed.', 'error');
                    } finally {
                        // Hide loading
                        document.getElementById('csv-loading').classList.add('hidden');
                        document.getElementById('csv-text').textContent = '‚¨áÔ∏è Download CSV Report';
                    }
                }, 500);
                
            } catch (error) {
                console.error('CSV download error:', error);
                showMessage('‚ùå CSV export failed.', 'error');
            }
        }

        // Sync to cloud
        async function syncToCloud() {
            if (!isReportDelivered) {
                showMessage('‚ùå Please deliver the report first before syncing.', 'error');
                return;
            }
            
            if (!window.firebase.db) {
                showMessage('‚ùå Cloud sync not available in demo mode.', 'error');
                return;
            }
            
            if (!window.isOnline) {
                showMessage('‚ùå No internet connection. Data will sync when online.', 'error');
                return;
            }
            
            try {
                // Show loading
                document.getElementById('sync-loading').classList.remove('hidden');
                document.getElementById('sync-text').textContent = 'Syncing...';
                
                // Upload all data types to Firestore with delivered status
                for (const activity of dailyActivities) {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'daily-activities'), {
                        ...activity,
                        reportDelivered: true,
                        deliveredAt: new Date().toISOString(),
                        createdAt: window.firebase.serverTimestamp()
                    });
                }
                
                for (const safety of dailySafetyReports) {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'safety-reports'), {
                        ...safety,
                        reportDelivered: true,
                        deliveredAt: new Date().toISOString(),
                        createdAt: window.firebase.serverTimestamp()
                    });
                }
                
                for (const progress of dailyProgressReports) {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'progress-reports'), {
                        ...progress,
                        reportDelivered: true,
                        deliveredAt: new Date().toISOString(),
                        createdAt: window.firebase.serverTimestamp()
                    });
                }
                
                for (const quality of dailyQualityReports) {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'quality-reports'), {
                        ...quality,
                        reportDelivered: true,
                        deliveredAt: new Date().toISOString(),
                        createdAt: window.firebase.serverTimestamp()
                    });
                }
                
                showMessage('‚úÖ All data synced to cloud successfully!', 'success');
                
            } catch (error) {
                console.error('Cloud sync error:', error);
                showMessage('‚ùå Cloud sync failed. Will retry automatically.', 'error');
            } finally {
                // Hide loading
                document.getElementById('sync-loading').classList.add('hidden');
                document.getElementById('sync-text').textContent = '‚òÅÔ∏è Sync to Cloud';
            }
        }

        // Auto sync to cloud when online
        async function autoSyncToCloud() {
            if (window.firebase.db && window.isOnline && isReportDelivered) {
                console.log('Auto-syncing delivered report to cloud...');
                await syncToCloud();
            }
        }

        // Auto-save function
        function autoSave() {
            try {
                const hasData = dailyActivities.length > 0 || dailySafetyReports.length > 0 || 
                               dailyProgressReports.length > 0 || dailyQualityReports.length > 0;
                               
                if (hasData) {
                    const today = new Date().toISOString().split('T')[0];
                    const draftData = {
                        date: today,
                        isReportDelivered: isReportDelivered,
                        dailyActivities: dailyActivities,
                        dailySafetyReports: dailySafetyReports,
                        dailyProgressReports: dailyProgressReports,
                        dailyQualityReports: dailyQualityReports,
                        overviewData: {
                            projectName: document.getElementById('project-name').value,
                            customProjectName: document.getElementById('custom-project-name').value,
                            reportedBy: document.getElementById('reported-by').value,
                            weather: document.getElementById('weather').value,
                            siteConditions: document.getElementById('site-conditions').value
                        },
                        savedAt: new Date().toLocaleString()
                    };
                    
                    // Save to localStorage
                    try {
                        localStorage.setItem('dailySiteReportData', JSON.stringify(draftData));
                    } catch (e) {
                        console.warn('localStorage save failed:', e);
                    }
                    
                    // Update sync status
                    document.getElementById('sync-status').textContent = 'Saved locally';
                    
                    console.log('Data auto-saved');
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        // Load saved data
        function loadSavedData() {
            try {
                const today = new Date().toISOString().split('T')[0];
                let data = null;
                
                // Try to load from localStorage
                try {
                    const stored = localStorage.getItem('dailySiteReportData');
                    if (stored) {
                        data = JSON.parse(stored);
                    }
                } catch (e) {
                    console.warn('localStorage load failed:', e);
                }
                
                if (data && data.date === today) {
                    // Load delivery status
                    if (data.isReportDelivered) {
                        isReportDelivered = true;
                        document.getElementById('status-bar').classList.add('delivered');
                        document.getElementById('report-title').innerHTML = 'üìã Report Delivered';
                        document.getElementById('deliver-text').textContent = '‚úÖ Report Delivered';
                    }
                    
                    // Load all data types
                    if (data.dailyActivities) {
                        dailyActivities = data.dailyActivities;
                    }
                    
                    if (data.dailySafetyReports) {
                        dailySafetyReports = data.dailySafetyReports;
                    }
                    
                    if (data.dailyProgressReports) {
                        dailyProgressReports = data.dailyProgressReports;
                    }
                    
                    if (data.dailyQualityReports) {
                        dailyQualityReports = data.dailyQualityReports;
                    }
                    
                    // Update all displays
                    updateAllDisplays();
                    
                    // Load overview data
                    if (data.overviewData) {
                        const overview = data.overviewData;
                        if (overview.projectName) document.getElementById('project-name').value = overview.projectName;
                        if (overview.customProjectName) document.getElementById('custom-project-name').value = overview.customProjectName;
                        if (overview.reportedBy) document.getElementById('reported-by').value = overview.reportedBy;
                        if (overview.weather) document.getElementById('weather').value = overview.weather;
                        if (overview.siteConditions) document.getElementById('site-conditions').value = overview.siteConditions;
                        
                        // Handle custom project display
                        handleProjectChange();
                    }
                    
                    console.log('Saved data loaded successfully');
                }
            } catch (error) {
                console.warn('Load saved data failed:', error);
            }
        }

        // PWA Install functionality
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-prompt').classList.add('show');
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted PWA install');
                        isAppInstalled = true;
                    }
                    deferredPrompt = null;
                    document.getElementById('install-prompt').classList.remove('show');
                });
            }
        }

        function dismissInstall() {
            document.getElementById('install-prompt').classList.remove('show');
            deferredPrompt = null;
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Loading Daily Site Report PWA...');
            init();
        });

        console.log('Daily Site Report PWA script loaded');
    </script>
</body>
</html>
