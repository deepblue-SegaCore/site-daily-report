<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Daily Report</title>
    
    <!-- Basic Mobile Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Site Report">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f9fafb;
            line-height: 1.5;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Status */
        .status {
            background: #10b981;
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 500;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .tab {
            flex: 1;
            padding: 16px 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            background: white;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #eff6ff;
        }
        
        /* Content */
        .content {
            padding: 20px;
            padding-bottom: 120px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .card h3 {
            color: #f59e0b;
            font-weight: 700;
            margin-bottom: 16px;
            font-size: 18px;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Photo Section */
        .photo-section {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            background: #fafafa;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .photo-name {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 20px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .bottom-nav .btn-group {
            max-width: 480px;
            margin: 0 auto;
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Entry Display */
        .entry-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .entry-header {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .entry-details {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .entry-photos {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
        }
        
        .entry-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
        }
        
        .success-message {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Site Daily Report</h1>
            <div class="header-info">
                <span id="current-date"></span> ‚Ä¢ <span id="current-time"></span>
            </div>
        </div>
        
        <!-- Status -->
        <div class="status">
            ‚úÖ App Connected ‚Ä¢ Ready to Use
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('basic', this)">üìù Basic</button>
            <button class="tab" onclick="showTab('resources', this)">üìã Resources</button>
            <button class="tab" onclick="showTab('entries', this)">üìä Entries</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Basic Info Tab -->
            <div id="basic-content" class="tab-content active">
                <!-- Date -->
                <div class="card">
                    <h3>üìÖ Date</h3>
                    <div class="form-group">
                        <input type="date" id="report-date" class="form-input">
                    </div>
                </div>

                <!-- Location -->
                <div class="card">
                    <h3>üìç Location</h3>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <select id="location" class="form-select">
                            <option value="">Select Location</option>
                            <option value="BF">BF</option>
                            <option value="1F">1F</option>
                            <option value="2F">2F</option>
                            <option value="3F">3F</option>
                            <option value="4F">4F</option>
                            <option value="5F">5F</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location Details</label>
                        <input type="text" id="location-details" placeholder="e.g., Room 301, North side" class="form-input">
                    </div>
                </div>

                <!-- Contractor -->
                <div class="card">
                    <h3>üë∑ Contractor</h3>
                    <div class="form-group">
                        <select id="contractor" class="form-select">
                            <option value="">Select Contractor</option>
                            <option value="Exyte-EE">Exyte-EE</option>
                            <option value="Exyte-HVAC">Exyte-HVAC</option>
                            <option value="Exyte-FS">Exyte-FS</option>
                            <option value="Exyte-BMS">Exyte-BMS</option>
                            <option value="Kinwil">Kinwil</option>
                            <option value="Quan Chun">Quan Chun</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                </div>

                <!-- Work -->
                <div class="card">
                    <h3>üîß Work Details</h3>
                    <div class="form-group">
                        <label class="form-label">Work Description</label>
                        <textarea id="work-description" placeholder="Describe the work performed..." rows="3" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Work Category</label>
                        <select id="work-category" class="form-select">
                            <option value="">Select Category</option>
                            <option value="HVAC">HVAC</option>
                            <option value="EE">EE (Electrical)</option>
                            <option value="FS">FS (Fire Safety)</option>
                            <option value="BMS">BMS</option>
                            <option value="Owner Works">Owner Works</option>
                            <option value="Tenant Works">Tenant Works</option>
                        </select>
                    </div>
                </div>

                <!-- Manpower -->
                <div class="card">
                    <h3>üë• Manpower</h3>
                    <div class="form-group">
                        <select id="manpower" class="form-select">
                            <option value="">Select Manpower</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>

                <!-- Plant -->
                <div class="card">
                    <h3>üèóÔ∏è Plant & Equipment</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select id="plant-type" class="form-select" onchange="toggleOtherPlant()">
                                <option value="">Select Type</option>
                                <option value="working platform">Working Platform</option>
                                <option value="others">Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Number</label>
                            <select id="plant-number" class="form-select">
                                <option value="">Number</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group hidden" id="plant-other-group">
                        <label class="form-label">Specify Other Type</label>
                        <input type="text" id="plant-other" placeholder="Other plant type..." class="form-input">
                    </div>
                </div>
            </div>

            <!-- Resources Tab -->
            <div id="resources-content" class="tab-content">
                <!-- Material -->
                <div class="card">
                    <h3>üì¶ Material Usage</h3>
                    <div class="form-group">
                        <textarea id="material-usage" placeholder="Material usage and delivery details..." rows="3" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Resource Utilization -->
                <div class="card">
                    <h3>‚ö° Resource Utilization</h3>
                    <div class="form-group">
                        <textarea id="resource-utilization" placeholder="Resource utilization and productivity notes..." rows="3" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Safety -->
                <div class="card">
                    <h3>üõ°Ô∏è Safety</h3>
                    <div class="form-group">
                        <textarea id="safety-observations" placeholder="Safety incidents and observations..." rows="3" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Weekly Programme -->
                <div class="card">
                    <h3>üìã Weekly Programme</h3>
                    <div class="form-group">
                        <textarea id="weekly-programme" placeholder="Weekly programme details..." rows="2" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Remarks -->
                <div class="card">
                    <h3>üí¨ Remarks</h3>
                    <div class="form-group">
                        <textarea id="remarks" placeholder="Additional remarks and notes..." rows="3" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Photos -->
                <div class="card">
                    <h3>üì∏ Photos</h3>
                    
                    <!-- Photo 1 -->
                    <div class="photo-section">
                        <label class="form-label">Photo 1</label>
                        <div id="photo1-preview" class="hidden">
                            <img id="photo1-img" class="photo-preview">
                            <div class="photo-name" id="photo1-name"></div>
                            <button onclick="removePhoto(1)" class="btn" style="background: #ef4444; color: white; width: auto; padding: 12px 24px;">Remove</button>
                        </div>
                        <div id="photo1-input">
                            <div class="grid-2" style="margin-bottom: 12px;">
                                <button onclick="capturePhoto(1)" class="btn btn-primary">üì∑ Camera</button>
                                <button onclick="selectPhoto(1)" class="btn" style="background: #6b7280; color: white;">üìÅ Gallery</button>
                            </div>
                            <input type="file" id="photo1-camera" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto(1, this)">
                            <input type="file" id="photo1-gallery" accept="image/*" style="display: none;" onchange="handlePhoto(1, this)">
                        </div>
                    </div>

                    <!-- Photo 2 -->
                    <div class="photo-section">
                        <label class="form-label">Photo 2</label>
                        <div id="photo2-preview" class="hidden">
                            <img id="photo2-img" class="photo-preview">
                            <div class="photo-name" id="photo2-name"></div>
                            <button onclick="removePhoto(2)" class="btn" style="background: #ef4444; color: white; width: auto; padding: 12px 24px;">Remove</button>
                        </div>
                        <div id="photo2-input">
                            <div class="grid-2" style="margin-bottom: 12px;">
                                <button onclick="capturePhoto(2)" class="btn btn-primary">üì∑ Camera</button>
                                <button onclick="selectPhoto(2)" class="btn" style="background: #6b7280; color: white;">üìÅ Gallery</button>
                            </div>
                            <input type="file" id="photo2-camera" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto(2, this)">
                            <input type="file" id="photo2-gallery" accept="image/*" style="display: none;" onchange="handlePhoto(2, this)">
                        </div>
                    </div>

                    <!-- Photo 3 -->
                    <div class="photo-section">
                        <label class="form-label">Photo 3</label>
                        <div id="photo3-preview" class="hidden">
                            <img id="photo3-img" class="photo-preview">
                            <div class="photo-name" id="photo3-name"></div>
                            <button onclick="removePhoto(3)" class="btn" style="background: #ef4444; color: white; width: auto; padding: 12px 24px;">Remove</button>
                        </div>
                        <div id="photo3-input">
                            <div class="grid-2" style="margin-bottom: 12px;">
                                <button onclick="capturePhoto(3)" class="btn btn-primary">üì∑ Camera</button>
                                <button onclick="selectPhoto(3)" class="btn" style="background: #6b7280; color: white;">üìÅ Gallery</button>
                            </div>
                            <input type="file" id="photo3-camera" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto(3, this)">
                            <input type="file" id="photo3-gallery" accept="image/*" style="display: none;" onchange="handlePhoto(3, this)">
                        </div>
                    </div>
                </div>

                <!-- Add Entry Button -->
                <button onclick="addWorkEntry()" class="btn btn-success">‚ûï Add Work Entry</button>
                
                <div id="entry-message"></div>
            </div>

            <!-- Entries Tab -->
            <div id="entries-content" class="tab-content">
                <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <h2 style="color: white; margin-bottom: 8px;">Work Entries</h2>
                    <p style="opacity: 0.9;"><span id="entry-count">0</span> entries recorded today</p>
                </div>

                <!-- Export Section -->
                <div class="card">
                    <h3>üì§ Export Options</h3>
                    <div class="grid-2">
                        <button onclick="downloadCSV()" id="download-btn" class="btn btn-success" disabled>‚¨áÔ∏è CSV</button>
                        <button onclick="downloadPhotos()" id="photos-btn" class="btn btn-warning" disabled>üì∏ Photos</button>
                    </div>
                    <p id="export-message" class="text-center" style="color: #6b7280; margin-top: 12px; font-size: 14px;">Add work entries to enable export</p>
                </div>

                <!-- Entries List -->
                <div id="entries-list">
                    <div class="card text-center" style="padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                        <p style="color: #6b7280;">No work entries yet.<br>Add your first entry to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="btn-group grid-2">
                <button onclick="saveDraft()" class="btn" style="background: #6b7280; color: white;">üíæ Save Draft</button>
                <button onclick="submitReport()" class="btn btn-primary">üìß Submit Report</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let workEntries = [];
        let photos = {1: null, 2: null, 3: null};

        // Initialize app
        function init() {
            console.log('App starting...');
            
            try {
                // Set current date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('report-date').value = today;
                
                // Start time updates
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Init error:', error);
                showMessage('‚ö†Ô∏è App initialization failed. Please refresh the page.', 'error');
            }
        }

        // Update date and time
        function updateDateTime() {
            try {
                const now = new Date();
                const dateEl = document.getElementById('current-date');
                const timeEl = document.getElementById('current-time');
                
                if (dateEl) dateEl.textContent = now.toLocaleDateString();
                if (timeEl) timeEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (error) {
                console.warn('DateTime update failed:', error);
            }
        }

        // Tab navigation
        function showTab(tabName, element) {
            try {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                const targetContent = document.getElementById(tabName + '-content');
                if (targetContent) {
                    targetContent.classList.add('active');
                }
                
                // Add active class to clicked tab
                if (element) {
                    element.classList.add('active');
                }
            } catch (error) {
                console.error('Tab switching error:', error);
            }
        }

        // Toggle other plant type
        function toggleOtherPlant() {
            try {
                const plantType = document.getElementById('plant-type').value;
                const otherGroup = document.getElementById('plant-other-group');
                
                if (plantType === 'others') {
                    otherGroup.classList.remove('hidden');
                } else {
                    otherGroup.classList.add('hidden');
                    document.getElementById('plant-other').value = '';
                }
            } catch (error) {
                console.error('Plant toggle error:', error);
            }
        }

        // Photo functions
        function capturePhoto(photoNum) {
            try {
                const cameraInput = document.getElementById(`photo${photoNum}-camera`);
                if (cameraInput) {
                    cameraInput.click();
                }
            } catch (error) {
                console.error('Camera capture error:', error);
                showMessage('‚ùå Camera access failed. Try using gallery instead.', 'error');
            }
        }

        function selectPhoto(photoNum) {
            try {
                const galleryInput = document.getElementById(`photo${photoNum}-gallery`);
                if (galleryInput) {
                    galleryInput.click();
                }
            } catch (error) {
                console.error('Gallery selection error:', error);
            }
        }

        function handlePhoto(photoNum, input) {
            try {
                const file = input.files[0];
                if (!file) return;
                
                // Check file size (limit to 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('‚ùå Photo too large. Please select a smaller image (max 5MB).', 'error');
                    return;
                }
                
                // Check file type
                if (!file.type.startsWith('image/')) {
                    showMessage('‚ùå Please select a valid image file.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        photos[photoNum] = {
                            data: e.target.result,
                            name: file.name
                        };
                        
                        // Show preview
                        const imgEl = document.getElementById(`photo${photoNum}-img`);
                        const nameEl = document.getElementById(`photo${photoNum}-name`);
                        const previewEl = document.getElementById(`photo${photoNum}-preview`);
                        const inputEl = document.getElementById(`photo${photoNum}-input`);
                        
                        if (imgEl) imgEl.src = e.target.result;
                        if (nameEl) nameEl.textContent = file.name;
                        if (previewEl) previewEl.classList.remove('hidden');
                        if (inputEl) inputEl.classList.add('hidden');
                        
                        showMessage(`‚úÖ Photo ${photoNum} uploaded successfully!`, 'success');
                    } catch (error) {
                        console.error('Photo preview error:', error);
                        showMessage('‚ùå Photo preview failed.', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showMessage('‚ùå Failed to read photo file.', 'error');
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Photo handling error:', error);
                showMessage('‚ùå Photo upload failed.', 'error');
            }
        }

        function removePhoto(photoNum) {
            try {
                photos[photoNum] = null;
                
                const previewEl = document.getElementById(`photo${photoNum}-preview`);
                const inputEl = document.getElementById(`photo${photoNum}-input`);
                const cameraEl = document.getElementById(`photo${photoNum}-camera`);
                const galleryEl = document.getElementById(`photo${photoNum}-gallery`);
                
                if (previewEl) previewEl.classList.add('hidden');
                if (inputEl) inputEl.classList.remove('hidden');
                if (cameraEl) cameraEl.value = '';
                if (galleryEl) galleryEl.value = '';
                
                showMessage(`‚úÖ Photo ${photoNum} removed.`, 'success');
            } catch (error) {
                console.error('Photo removal error:', error);
            }
        }

        // Add work entry
        function addWorkEntry() {
            try {
                const location = document.getElementById('location').value;
                const contractor = document.getElementById('contractor').value;
                
                if (!location || !contractor) {
                    showMessage('‚ùå Please fill in at least Location and Contractor fields', 'error');
                    return;
                }

                const entry = {
                    id: Date.now(),
                    date: document.getElementById('report-date').value,
                    location: location,
                    locationDetails: document.getElementById('location-details').value || '',
                    contractor: contractor,
                    workDescription: document.getElementById('work-description').value || '',
                    workCategory: document.getElementById('work-category').value || '',
                    manpower: document.getElementById('manpower').value || '',
                    plantType: document.getElementById('plant-type').value || '',
                    plantNumber: document.getElementById('plant-number').value || '',
                    plantOtherType: document.getElementById('plant-other').value || '',
                    materialUsage: document.getElementById('material-usage').value || '',
                    resourceUtilization: document.getElementById('resource-utilization').value || '',
                    safetyObservations: document.getElementById('safety-observations').value || '',
                    weeklyProgramme: document.getElementById('weekly-programme').value || '',
                    remarks: document.getElementById('remarks').value || '',
                    photos: JSON.parse(JSON.stringify(photos)), // Deep copy
                    timestamp: new Date().toLocaleString()
                };

                workEntries.push(entry);
                clearForm();
                updateEntriesDisplay();
                updateExportButtons();
                
                showMessage('‚úÖ Work entry added successfully!', 'success');
                
                // Auto-switch to entries tab
                setTimeout(() => {
                    const entriesTab = document.querySelector('.tab:nth-child(3)');
                    if (entriesTab) {
                        showTab('entries', entriesTab);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Add entry error:', error);
                showMessage('‚ùå Failed to add work entry. Please try again.', 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            try {
                const messageDiv = document.getElementById('entry-message');
                if (messageDiv) {
                    messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
                    messageDiv.textContent = message;
                    
                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 3000);
                }
            } catch (error) {
                console.error('Message display error:', error);
            }
        }

        // Clear form
        function clearForm() {
            try {
                const formFields = [
                    'location', 'location-details', 'contractor', 'work-description',
                    'work-category', 'manpower', 'plant-type', 'plant-number',
                    'plant-other', 'material-usage', 'resource-utilization',
                    'safety-observations', 'weekly-programme', 'remarks'
                ];
                
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = '';
                });
                
                // Clear photos
                for (let i = 1; i <= 3; i++) {
                    removePhoto(i);
                }
                
                toggleOtherPlant();
            } catch (error) {
                console.error('Form clearing error:', error);
            }
        }

        // Update entries display
        function updateEntriesDisplay() {
            try {
                const countEl = document.getElementById('entry-count');
                if (countEl) countEl.textContent = workEntries.length;
                
                const entriesList = document.getElementById('entries-list');
                if (!entriesList) return;
                
                if (workEntries.length === 0) {
                    entriesList.innerHTML = `
                        <div class="card text-center" style="padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                            <p style="color: #6b7280;">No work entries yet.<br>Add your first entry to get started!</p>
                        </div>
                    `;
                } else {
                    entriesList.innerHTML = workEntries.map((entry, index) => `
                        <div class="entry-card">
                            <div class="entry-header">Entry #${index + 1} - ${entry.contractor}</div>
                            <div class="entry-details">
                                <div><strong>üìç Location:</strong> ${entry.location}${entry.locationDetails ? ' - ' + entry.locationDetails : ''}</div>
                                <div><strong>üîß Work:</strong> ${entry.workDescription || 'No description'}</div>
                                <div><strong>üë• Manpower:</strong> ${entry.manpower || 'Not specified'}</div>
                                ${entry.plantType ? `<div><strong>üèóÔ∏è Plant:</strong> ${entry.plantNumber} x ${entry.plantType}</div>` : ''}
                                ${entry.safetyObservations ? `<div style="background: #fef3cd; padding: 8px; border-radius: 4px; margin-top: 8px;"><strong>üõ°Ô∏è Safety:</strong> ${entry.safetyObservations}</div>` : ''}
                                ${entry.remarks ? `<div style="background: #eff6ff; padding: 8px; border-radius: 4px; margin-top: 8px;"><strong>üí¨ Remarks:</strong> ${entry.remarks}</div>` : ''}
                                ${getPhotosHTML(entry.photos)}
                                <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">‚è∞ ${entry.timestamp}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Entries display error:', error);
            }
        }

        // Get photos HTML for display
        function getPhotosHTML(entryPhotos) {
            try {
                const photoElements = [];
                for (let i = 1; i <= 3; i++) {
                    if (entryPhotos && entryPhotos[i] && entryPhotos[i].data) {
                        photoElements.push(`<img src="${entryPhotos[i].data}" alt="Photo ${i}" class="entry-photo">`);
                    }
                }
                
                if (photoElements.length > 0) {
                    return `<div class="entry-photos">${photoElements.join('')}</div>`;
                }
                return '';
            } catch (error) {
                console.error('Photos HTML error:', error);
                return '';
            }
        }

        // Update export buttons
        function updateExportButtons() {
            try {
                const hasEntries = workEntries.length > 0;
                const downloadBtn = document.getElementById('download-btn');
                const photosBtn = document.getElementById('photos-btn');
                const exportMsg = document.getElementById('export-message');
                
                if (downloadBtn) downloadBtn.disabled = !hasEntries;
                if (photosBtn) photosBtn.disabled = !hasEntries;
                if (exportMsg) exportMsg.style.display = hasEntries ? 'none' : 'block';
            } catch (error) {
                console.error('Export buttons update error:', error);
            }
        }

        // Generate CSV with improved error handling
        function generateCSV() {
            try {
                const headers = [
                    'Date', 'Location', 'Location Details', 'Contractor', 'Work Description',
                    'Work Category', 'Manpower', 'Plant Type', 'Plant Number', 'Plant Other Type',
                    'Material Usage', 'Resource Utilization', 'Safety Observations',
                    'Weekly Programme', 'Remarks', 'Photo 1', 'Photo 2', 'Photo 3', 'Timestamp'
                ];
                
                const csvRows = workEntries.map(entry => [
                    entry.date || '',
                    `"${(entry.location || '').replace(/"/g, '""')}"`,
                    `"${(entry.locationDetails || '').replace(/"/g, '""')}"`,
                    `"${(entry.contractor || '').replace(/"/g, '""')}"`,
                    `"${(entry.workDescription || '').replace(/"/g, '""')}"`,
                    `"${(entry.workCategory || '').replace(/"/g, '""')}"`,
                    entry.manpower || '',
                    `"${(entry.plantType || '').replace(/"/g, '""')}"`,
                    entry.plantNumber || '',
                    `"${(entry.plantOtherType || '').replace(/"/g, '""')}"`,
                    `"${(entry.materialUsage || '').replace(/"/g, '""')}"`,
                    `"${(entry.resourceUtilization || '').replace(/"/g, '""')}"`,
                    `"${(entry.safetyObservations || '').replace(/"/g, '""')}"`,
                    `"${(entry.weeklyProgramme || '').replace(/"/g, '""')}"`,
                    `"${(entry.remarks || '').replace(/"/g, '""')}"`,
                    `"${(entry.photos && entry.photos[1] ? entry.photos[1].name : '')}"`,
                    `"${(entry.photos && entry.photos[2] ? entry.photos[2].name : '')}"`,
                    `"${(entry.photos && entry.photos[3] ? entry.photos[3].name : '')}"`,
                    `"${(entry.timestamp || '').replace(/"/g, '""')}"`
                ].join(','));
                
                return [headers.join(','), ...csvRows].join('\n');
            } catch (error) {
                console.error('CSV generation error:', error);
                throw new Error('Failed to generate CSV');
            }
        }

        // Download CSV with better error handling
        function downloadCSV() {
            try {
                if (workEntries.length === 0) {
                    showMessage('‚ùå No entries to export.', 'error');
                    return;
                }
                
                const csvContent = generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `site_daily_report_${document.getElementById('report-date').value}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the URL object
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                showMessage('‚úÖ CSV downloaded successfully!', 'success');
            } catch (error) {
                console.error('CSV download error:', error);
                showMessage('‚ùå CSV export failed. Please try again.', 'error');
            }
        }

        // Download photos with improved error handling
        function downloadPhotos() {
            try {
                if (workEntries.length === 0) {
                    showMessage('‚ùå No entries to export.', 'error');
                    return;
                }
                
                createHTMLPhotoReport();
            } catch (error) {
                console.error('Photo export error:', error);
                showMessage('‚ùå Photo export failed. Please try again.', 'error');
            }
        }

        // Create HTML photo report with better error handling
        function createHTMLPhotoReport() {
            try {
                const reportDate = document.getElementById('report-date').value;
                
                let photoHTML = `<!DOCTYPE html>
<html>
<head>
    <title>Site Report Photos - ${reportDate}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.5; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .entry { margin-bottom: 40px; border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        .entry-header { background: #f0f0f0; padding: 10px; margin: -20px -20px 15px -20px; border-radius: 8px 8px 0 0; }
        .photo-container { margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        img { max-width: 100%; height: auto; margin: 10px 0; border: 1px solid #ccc; }
        .details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .detail { padding: 5px 0; }
        .section-title { font-weight: bold; color: #2563eb; margin: 15px 0 5px 0; }
        .remarks { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .safety { background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Site Daily Report - Photos</h1>
        <h2>üìÖ Date: ${reportDate}</h2>
        <p>üïê Generated: ${new Date().toLocaleString()}</p>
        <p>üìã Total Entries: ${workEntries.length}</p>
    </div>`;

                workEntries.forEach((entry, index) => {
                    photoHTML += `
    <div class="entry">
        <div class="entry-header">
            <h3>Entry #${index + 1}</h3>
        </div>
        
        <div class="details">
            <div class="detail"><strong>üìç Location:</strong> ${entry.location || ''}</div>
            <div class="detail"><strong>üë∑ Contractor:</strong> ${entry.contractor || ''}</div>
            <div class="detail"><strong>üîß Category:</strong> ${entry.workCategory || ''}</div>
            <div class="detail"><strong>üë• Manpower:</strong> ${entry.manpower || ''}</div>
        </div>
        
        <div class="detail"><strong>üìç Location Details:</strong> ${entry.locationDetails || ''}</div>
        <div class="detail"><strong>üèóÔ∏è Plant & Equipment:</strong> ${entry.plantNumber || ''} x ${entry.plantType || ''} ${entry.plantOtherType || ''}</div>
        <div class="detail"><strong>‚è∞ Timestamp:</strong> ${entry.timestamp || ''}</div>`;
                    
                    if (entry.workDescription) {
                        photoHTML += `
        <div class="section-title">üîß Work Description:</div>
        <div>${entry.workDescription}</div>`;
                    }
                    
                    if (entry.remarks) {
                        photoHTML += `
        <div class="section-title">üí¨ Remarks:</div>
        <div class="remarks">${entry.remarks}</div>`;
                    }
                    
                    if (entry.safetyObservations) {
                        photoHTML += `
        <div class="section-title">üõ°Ô∏è Safety Observations:</div>
                        <div class="safety">${entry.safetyObservations}</div>`;
                    }
                    
                    // Add photos
                    for (let i = 1; i <= 3; i++) {
                        if (entry.photos && entry.photos[i] && entry.photos[i].data) {
                            photoHTML += `
        <div class="photo-container">
            <div class="section-title">üì∏ Photo ${i}: ${entry.photos[i].name || `Photo ${i}`}</div>
            <img src="${entry.photos[i].data}" alt="Photo ${i}">
        </div>`;
                        }
                    }
                    
                    photoHTML += `    </div>`;
                });

                photoHTML += `</body></html>`;

                // Download the HTML file
                const blob = new Blob([photoHTML], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `site_report_photos_${reportDate}.html`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the URL object
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                showMessage('‚úÖ Photos exported successfully!', 'success');
            } catch (error) {
                console.error('HTML photo report error:', error);
                throw error;
            }
        }

        // Save draft - using in-memory storage only (no localStorage/sessionStorage)
        function saveDraft() {
            try {
                const draftData = {
                    date: document.getElementById('report-date').value,
                    location: document.getElementById('location').value,
                    locationDetails: document.getElementById('location-details').value,
                    contractor: document.getElementById('contractor').value,
                    workDescription: document.getElementById('work-description').value,
                    workCategory: document.getElementById('work-category').value,
                    manpower: document.getElementById('manpower').value,
                    plantType: document.getElementById('plant-type').value,
                    plantNumber: document.getElementById('plant-number').value,
                    plantOtherType: document.getElementById('plant-other').value,
                    materialUsage: document.getElementById('material-usage').value,
                    resourceUtilization: document.getElementById('resource-utilization').value,
                    safetyObservations: document.getElementById('safety-observations').value,
                    weeklyProgramme: document.getElementById('weekly-programme').value,
                    remarks: document.getElementById('remarks').value,
                    photos: JSON.parse(JSON.stringify(photos)),
                    workEntries: JSON.parse(JSON.stringify(workEntries)),
                    savedAt: new Date().toLocaleString()
                };
                
                // Store in global variable for session persistence
                window.draftData = draftData;
                
                showMessage('‚úÖ Draft saved for this session!', 'success');
            } catch (error) {
                console.error('Save draft error:', error);
                showMessage('‚ùå Save failed: ' + error.message, 'error');
            }
        }

        // Submit report
        function submitReport() {
            try {
                if (workEntries.length === 0) {
                    showMessage('‚ùå Cannot submit empty report. Please add at least one work entry.', 'error');
                    return;
                }
                
                const reportData = {
                    date: document.getElementById('report-date').value,
                    totalEntries: workEntries.length,
                    submittedAt: new Date().toLocaleString()
                };
                
                const referenceNumber = `SDR-${reportData.date.replace(/-/g, '')}-${Date.now()}`;
                
                if (confirm(`üìß Submit Report?\n\n‚Ä¢ Date: ${reportData.date}\n‚Ä¢ Entries: ${reportData.totalEntries}\n‚Ä¢ Reference: ${referenceNumber}\n\nContinue?`)) {
                    // Clear draft
                    window.draftData = null;
                    
                    showMessage(`‚úÖ Report submitted successfully!\n\n‚Ä¢ Reference: ${referenceNumber}\n‚Ä¢ Submitted: ${reportData.submittedAt}`, 'success');
                    
                    // Ask about new report
                    setTimeout(() => {
                        if (confirm('üÜï Start new report?\n\nThis will clear all data.')) {
                            location.reload();
                        }
                    }, 2000);
                }
            } catch (error) {
                console.error('Submit report error:', error);
                showMessage('‚ùå Submit failed. Please try again.', 'error');
            }
        }

        // Load draft from session
        function loadDraft() {
            try {
                const draftData = window.draftData;
                if (!draftData) return false;
                
                // Load all form data
                const formFields = {
                    'report-date': 'date',
                    'location': 'location',
                    'location-details': 'locationDetails',
                    'contractor': 'contractor',
                    'work-description': 'workDescription',
                    'work-category': 'workCategory',
                    'manpower': 'manpower',
                    'plant-type': 'plantType',
                    'plant-number': 'plantNumber',
                    'plant-other': 'plantOtherType',
                    'material-usage': 'materialUsage',
                    'resource-utilization': 'resourceUtilization',
                    'safety-observations': 'safetyObservations',
                    'weekly-programme': 'weeklyProgramme',
                    'remarks': 'remarks'
                };
                
                Object.keys(formFields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const dataKey = formFields[fieldId];
                    if (field && draftData[dataKey]) {
                        field.value = draftData[dataKey];
                    }
                });
                
                // Load photos
                if (draftData.photos) {
                    photos = JSON.parse(JSON.stringify(draftData.photos));
                    for (let i = 1; i <= 3; i++) {
                        if (photos[i]) {
                            try {
                                const imgEl = document.getElementById(`photo${i}-img`);
                                const nameEl = document.getElementById(`photo${i}-name`);
                                const previewEl = document.getElementById(`photo${i}-preview`);
                                const inputEl = document.getElementById(`photo${i}-input`);
                                
                                if (imgEl) imgEl.src = photos[i].data;
                                if (nameEl) nameEl.textContent = photos[i].name;
                                if (previewEl) previewEl.classList.remove('hidden');
                                if (inputEl) inputEl.classList.add('hidden');
                            } catch (e) {
                                console.warn(`Could not load photo ${i}:`, e);
                            }
                        }
                    }
                }
                
                // Load work entries
                if (draftData.workEntries) {
                    workEntries = JSON.parse(JSON.stringify(draftData.workEntries));
                    updateEntriesDisplay();
                    updateExportButtons();
                }
                
                toggleOtherPlant();
                
                showMessage(`‚úÖ Draft loaded successfully! Saved: ${draftData.savedAt}`, 'success');
                return true;
            } catch (error) {
                console.error('Load draft error:', error);
                showMessage('‚ùå Error loading draft. Starting fresh.', 'error');
                return false;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            init();
            
            // Check for draft after initialization
            setTimeout(() => {
                try {
                    if (window.draftData) {
                        if (confirm('üìÑ Found saved draft. Continue working on it?')) {
                            loadDraft();
                        }
                    }
                } catch (error) {
                    console.warn('Draft check failed:', error);
                }
            }, 1000);
        });

        console.log('Site Daily Report app script loaded successfully');
    </script>
</body>
</html>
