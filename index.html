<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Daily Report</title>
    
    <!-- Basic Mobile Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Site Report">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f9fafb;
            line-height: 1.5;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Status */
        .status {
            background: #10b981;
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 500;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .tab {
            flex: 1;
            padding: 16px 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            background: white;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #eff6ff;
        }
        
        /* Content */
        .content {
            padding: 20px;
            padding-bottom: 120px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .card h3 {
            color: #f59e0b;
            font-weight: 700;
            margin-bottom: 16px;
            font-size: 18px;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Required field styling */
        .form-input.required-empty, .form-select.required-empty {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .form-select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Photo Section */
        .photo-section {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            background: #fafafa;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .photo-name {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 20px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .bottom-nav .btn-group {
            max-width: 480px;
            margin: 0 auto;
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Entry Display */
        .entry-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .entry-header {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .entry-details {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .entry-photos {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
        }
        
        .entry-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
        }
        
        .success-message {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .warning-message {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            color: #d97706;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-weight: 500;
        }
        
        /* Help text */
        .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .required-info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1e40af;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Site Daily Report</h1>
            <div class="header-info">
                <span id="current-date"></span> ‚Ä¢ <span id="current-time"></span>
            </div>
        </div>
        
        <!-- Status -->
        <div class="status">
            ‚úÖ App Connected ‚Ä¢ Ready to Use
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('basic', this)">üìù Basic</button>
            <button class="tab" onclick="showTab('resources', this)">üìã Resources</button>
            <button class="tab" onclick="showTab('entries', this)">üìä Entries</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Basic Info Tab -->
            <div id="basic-content" class="tab-content active">
                <!-- Date -->
                <div class="card">
                    <h3>üìÖ Date</h3>
                    <div class="form-group">
                        <input type="date" id="report-date" class="form-input">
                    </div>
                </div>

                <!-- Location -->
                <div class="card">
                    <h3>üìç Location</h3>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <select id="location" class="form-select">
                            <option value="">Select Location</option>
                            <option value="BF">BF</option>
                            <option value="1F">1F</option>
                            <option value="2F">2F</option>
                            <option value="3F">3F</option>
                            <option value="4F">4F</option>
                            <option value="5F">5F</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location Details</label>
                        <input type="text" id="location-details" placeholder="e.g., Room 301, North side" class="form-input">
                    </div>
                </div>

                <!-- Contractor -->
                <div class="card">
                    <h3>üë∑ Contractor</h3>
                    <div class="form-group">
                        <select id="contractor" class="form-select">
                            <option value="">Select Contractor</option>
                            <option value="Exyte-EE">Exyte-EE</option>
                            <option value="Exyte-HVAC">Exyte-HVAC</option>
                            <option value="Exyte-FS">Exyte-FS</option>
                            <option value="Exyte-BMS">Exyte-BMS</option>
                            <option value="Kinwil">Kinwil</option>
                            <option value="Quan Chun">Quan Chun</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                </div>

                <!-- Work -->
                <div class="card">
                    <h3>üîß Work Details</h3>
                    <div class="form-group">
                        <label class="form-label">Work Description</label>
                        <textarea id="work-description" placeholder="Describe the work performed..." rows="3" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Work Category</label>
                        <select id="work-category" class="form-select">
                            <option value="">Select Category</option>
                            <option value="HVAC">HVAC</option>
                            <option value="EE">EE (Electrical)</option>
                            <option value="FS">FS (Fire Safety)</option>
                            <option value="BMS">BMS</option>
                            <option value="Owner Works">Owner Works</option>
                            <option value="Tenant Works">Tenant Works</option>
                        </select>
                    </div>
                </div>

                <!-- Manpower -->
                <div class="card">
                    <h3>üë• Manpower</h3>
                    <div class="form-group">
                        <select id="manpower" class="form-select">
                            <option value="">Select Manpower</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>

                <!-- Plant -->
                <div class="card">
                    <h3>üèóÔ∏è Plant & Equipment</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select id="plant-type" class="form-select" onchange="toggleOtherPlant()">
                                <option value="">Select Type</option>
                                <option value="working platform">Working Platform</option>
                                <option value="others">Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Number</label>
                            <select id="plant-number" class="form-select">
                                <option value="">Number</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group hidden" id="plant-other-group">
                        <label class="form-label">Specify Other Type</label>
                        <input type="text" id="plant-other" placeholder="Other plant type..." class="form-input">
                    </div>
                </div>
            </div>

            <!-- Resources Tab -->
            <div id="resources-content" class="tab-content">
                <!-- Work Entry Requirements -->
                <div class="required-info">
                    <strong>üìã To add work entry:</strong><br>
                    Fill in at least <strong>Location</strong> OR <strong>Contractor</strong> in the Basic tab
                </div>

                <!-- Material -->
                <div class="card">
                    <h3>üì¶ Material Usage</h3>
                    <div class="form-group">
                        <textarea id="material-usage" placeholder="Material usage and delivery details..." rows="3" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Resource Utilization -->
                <div class="card">
                    <h3>‚ö° Resource Utilization</h3>
                    <div class="form-group">
                        <textarea id="resource-utilization" placeholder="Resource utilization and productivity notes..." rows="3" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Safety -->
                <div class="card">
                    <h3>üõ°Ô∏è Safety</h3>
                    <div class="form-group">
                        <textarea id="safety-observations" placeholder="Safety incidents and observations..." rows="3" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Weekly Programme -->
                <div class="card">
                    <h3>üìã Weekly Programme</h3>
                    <div class="form-group">
                        <textarea id="weekly-programme" placeholder="Weekly programme details..." rows="2" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Remarks -->
                <div class="card">
                    <h3>üí¨ Remarks</h3>
                    <div class="form-group">
                        <textarea id="remarks" placeholder="Additional remarks and notes..." rows="3" class="form-textarea"></textarea>
                    </div>
                </div>

                <!-- Photos -->
                <div class="card">
                    <h3>üì∏ Photos</h3>
                    
                    <!-- Photo 1 -->
                    <div class="photo-section">
                        <label class="form-label">Photo 1</label>
                        <div id="photo1-preview" class="hidden">
                            <img id="photo1-img" class="photo-preview">
                            <div class="photo-name" id="photo1-name"></div>
                            <button onclick="removePhoto(1)" class="btn" style="background: #ef4444; color: white; width: auto; padding: 12px 24px;">Remove</button>
                        </div>
                        <div id="photo1-input">
                            <div class="grid-2" style="margin-bottom: 12px;">
                                <button onclick="capturePhoto(1)" class="btn btn-primary">üì∑ Camera</button>
                                <button onclick="selectPhoto(1)" class="btn" style="background: #6b7280; color: white;">üìÅ Gallery</button>
                            </div>
                            <input type="file" id="photo1-camera" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto(1, this)">
                            <input type="file" id="photo1-gallery" accept="image/*" style="display: none;" onchange="handlePhoto(1, this)">
                        </div>
                    </div>

                    <!-- Photo 2 -->
                    <div class="photo-section">
                        <label class="form-label">Photo 2</label>
                        <div id="photo2-preview" class="hidden">
                            <img id="photo2-img" class="photo-preview">
                            <div class="photo-name" id="photo2-name"></div>
                            <button onclick="removePhoto(2)" class="btn" style="background: #ef4444; color: white; width: auto; padding: 12px 24px;">Remove</button>
                        </div>
                        <div id="photo2-input">
                            <div class="grid-2" style="margin-bottom: 12px;">
                                <button onclick="capturePhoto(2)" class="btn btn-primary">üì∑ Camera</button>
                                <button onclick="selectPhoto(2)" class="btn" style="background: #6b7280; color: white;">üìÅ Gallery</button>
                            </div>
                            <input type="file" id="photo2-camera" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto(2, this)">
                            <input type="file" id="photo2-gallery" accept="image/*" style="display: none;" onchange="handlePhoto(2, this)">
                        </div>
                    </div>

                    <!-- Photo 3 -->
                    <div class="photo-section">
                        <label class="form-label">Photo 3</label>
                        <div id="photo3-preview" class="hidden">
                            <img id="photo3-img" class="photo-preview">
                            <div class="photo-name" id="photo3-name"></div>
                            <button onclick="removePhoto(3)" class="btn" style="background: #ef4444; color: white; width: auto; padding: 12px 24px;">Remove</button>
                        </div>
                        <div id="photo3-input">
                            <div class="grid-2" style="margin-bottom: 12px;">
                                <button onclick="capturePhoto(3)" class="btn btn-primary">üì∑ Camera</button>
                                <button onclick="selectPhoto(3)" class="btn" style="background: #6b7280; color: white;">üìÅ Gallery</button>
                            </div>
                            <input type="file" id="photo3-camera" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto(3, this)">
                            <input type="file" id="photo3-gallery" accept="image/*" style="display: none;" onchange="handlePhoto(3, this)">
                        </div>
                    </div>
                </div>

                <!-- Add Entry Button -->
                <button onclick="addWorkEntry()" class="btn btn-success">‚ûï Add Work Entry</button>
                
                <div id="entry-message"></div>
            </div>

            <!-- Entries Tab -->
            <div id="entries-content" class="tab-content">
                <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <h2 style="color: white; margin-bottom: 8px;">Work Entries</h2>
                    <p style="opacity: 0.9;"><span id="entry-count">0</span> entries recorded today</p>
                </div>

                <!-- Export Section -->
                <div class="card">
                    <h3>üì§ Export Options</h3>
                    <div class="grid-2">
                        <button onclick="downloadCSV()" id="download-btn" class="btn btn-success" disabled>‚¨áÔ∏è CSV</button>
                        <button onclick="downloadPhotos()" id="photos-btn" class="btn btn-warning" disabled>üì∏ Photos</button>
                    </div>
                    <p id="export-message" class="text-center" style="color: #6b7280; margin-top: 12px; font-size: 14px;">Add work entries to enable export</p>
                </div>

                <!-- Entries List -->
                <div id="entries-list">
                    <div class="card text-center" style="padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                        <p style="color: #6b7280;">No work entries yet.<br>Add your first entry to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="btn-group grid-2">
                <button onclick="saveDraft()" class="btn" style="background: #6b7280; color: white;">üíæ Save Draft</button>
                <button onclick="submitReport()" class="btn btn-primary">üìß Submit Report</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let workEntries = [];
        let photos = {1: null, 2: null, 3: null};

        // Initialize app immediately
        function init() {
            console.log('App starting...');
            
            // Set current date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            
            // Start time updates
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            console.log('App initialized successfully');
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString();
            document.getElementById('current-time').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Tab navigation
        function showTab(tabName, element) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Add active class to clicked tab
            element.classList.add('active');
        }

        // Toggle other plant type
        function toggleOtherPlant() {
            const plantType = document.getElementById('plant-type').value;
            const otherGroup = document.getElementById('plant-other-group');
            
            if (plantType === 'others') {
                otherGroup.classList.remove('hidden');
            } else {
                otherGroup.classList.add('hidden');
                document.getElementById('plant-other').value = '';
            }
        }

        // Photo functions
        function capturePhoto(photoNum) {
            document.getElementById(`photo${photoNum}-camera`).click();
        }

        function selectPhoto(photoNum) {
            document.getElementById(`photo${photoNum}-gallery`).click();
        }

        function handlePhoto(photoNum, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photos[photoNum] = {
                        data: e.target.result,
                        name: file.name
                    };
                    
                    // Show preview
                    document.getElementById(`photo${photoNum}-img`).src = e.target.result;
                    document.getElementById(`photo${photoNum}-name`).textContent = file.name;
                    document.getElementById(`photo${photoNum}-preview`).classList.remove('hidden');
                    document.getElementById(`photo${photoNum}-input`).classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto(photoNum) {
            photos[photoNum] = null;
            document.getElementById(`photo${photoNum}-preview`).classList.add('hidden');
            document.getElementById(`photo${photoNum}-input`).classList.remove('hidden');
            document.getElementById(`photo${photoNum}-camera`).value = '';
            document.getElementById(`photo${photoNum}-gallery`).value = '';
        }

        // IMPROVED Add work entry function
        function addWorkEntry() {
            // Debug: Let user know button was clicked
            console.log('Add Work Entry button clicked!');
            
            const location = document.getElementById('location').value;
            const contractor = document.getElementById('contractor').value;
            
            // Clear any previous error styling
            document.getElementById('location').classList.remove('required-empty');
            document.getElementById('contractor').classList.remove('required-empty');
            
            // IMPROVED VALIDATION: Require Location OR Contractor (not both)
            if (!location && !contractor) {
                showMessage('‚ùå Please fill in at least Location OR Contractor field', 'error');
                
                // Highlight empty required fields
                if (!location) document.getElementById('location').classList.add('required-empty');
                if (!contractor) document.getElementById('contractor').classList.add('required-empty');
                
                // Show which tab to go to
                showMessage('üí° Go to Basic tab to fill in Location or Contractor', 'warning');
                return;
            }

            // Show success immediately
            showMessage('‚úÖ Creating work entry...', 'success');

            const entry = {
                id: Date.now(),
                date: document.getElementById('report-date').value,
                location: location,
                locationDetails: document.getElementById('location-details').value,
                contractor: contractor,
                workDescription: document.getElementById('work-description').value,
                workCategory: document.getElementById('work-category').value,
                manpower: document.getElementById('manpower').value,
                plantType: document.getElementById('plant-type').value,
                plantNumber: document.getElementById('plant-number').value,
                plantOtherType: document.getElementById('plant-other').value,
                materialUsage: document.getElementById('material-usage').value,
                resourceUtilization: document.getElementById('resource-utilization').value,
                safetyObservations: document.getElementById('safety-observations').value,
                weeklyProgramme: document.getElementById('weekly-programme').value,
                remarks: document.getElementById('remarks').value,
                photos: {...photos},
                timestamp: new Date().toLocaleString()
            };

            workEntries.push(entry);
            clearForm();
            updateEntriesDisplay();
            updateExportButtons();
            
            showMessage('‚úÖ Work entry added successfully! Check the Entries tab.', 'success');
            
            // Auto-switch to entries tab to show the new entry
            setTimeout(() => {
                const entriesTab = document.querySelector('.tab[onclick*="entries"]');
                if (entriesTab) {
                    showTab('entries', entriesTab);
                }
            }, 1500);
        }

        // Show message with different types
        function showMessage(message, type) {
            const messageDiv = document.getElementById('entry-message');
            
            // Clear existing classes
            messageDiv.className = '';
            
            // Apply new class based on type
            if (type === 'success') {
                messageDiv.className = 'success-message';
            } else if (type === 'error') {
                messageDiv.className = 'error-message';
            } else if (type === 'warning') {
                messageDiv.className = 'warning-message';
            }
            
            messageDiv.textContent = message;
            
            // Auto-clear message after 5 seconds
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }

        // Clear form
        function clearForm() {
            document.getElementById('location').value = '';
            document.getElementById('location-details').value = '';
            document.getElementById('contractor').value = '';
            document.getElementById('work-description').value = '';
            document.getElementById('work-category').value = '';
            document.getElementById('manpower').value = '';
            document.getElementById('plant-type').value = '';
            document.getElementById('plant-number').value = '';
            document.getElementById('plant-other').value = '';
            document.getElementById('material-usage').value = '';
            document.getElementById('resource-utilization').value = '';
            document.getElementById('safety-observations').value = '';
            document.getElementById('weekly-programme').value = '';
            document.getElementById('remarks').value = '';
            
            // Clear photos
            for (let i = 1; i <= 3; i++) {
                removePhoto(i);
            }
            
            // Clear any error styling
            document.getElementById('location').classList.remove('required-empty');
            document.getElementById('contractor').classList.remove('required-empty');
            
            toggleOtherPlant();
        }

        // Update entries display
        function updateEntriesDisplay() {
            document.getElementById('entry-count').textContent = workEntries.length;
            
            const entriesList = document.getElementById('entries-list');
            
            if (workEntries.length === 0) {
                entriesList.innerHTML = `
                    <div class="card text-center" style="padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                        <p style="color: #6b7280;">No work entries yet.<br>Add your first entry to get started!</p>
                    </div>
                `;
            } else {
                entriesList.innerHTML = workEntries.map((entry, index) => `
                    <div class="entry-card">
                        <div class="entry-header">Entry #${index + 1} - ${entry.contractor || entry.location}</div>
                        <div class="entry-details">
                            <div><strong>üìç Location:</strong> ${entry.location || 'Not specified'}${entry.locationDetails ? ' - ' + entry.locationDetails : ''}</div>
                            <div><strong>üë∑ Contractor:</strong> ${entry.contractor || 'Not specified'}</div>
                            <div><strong>üîß Work:</strong> ${entry.workDescription || 'No description'}</div>
                            <div><strong>üë• Manpower:</strong> ${entry.manpower || 'Not specified'}</div>
                            ${entry.plantType ? `<div><strong>üèóÔ∏è Plant:</strong> ${entry.plantNumber} x ${entry.plantType}</div>` : ''}
                            ${entry.safetyObservations ? `<div style="background: #fef3cd; padding: 8px; border-radius: 4px; margin-top: 8px;"><strong>üõ°Ô∏è Safety:</strong> ${entry.safetyObservations}</div>` : ''}
                            ${entry.remarks ? `<div style="background: #eff6ff; padding: 8px; border-radius: 4px; margin-top: 8px;"><strong>üí¨ Remarks:</strong> ${entry.remarks}</div>` : ''}
                            ${getPhotosHTML(entry.photos)}
                            <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">‚è∞ ${entry.timestamp}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Get photos HTML for display
        function getPhotosHTML(entryPhotos) {
            const photoElements = [];
            for (let i = 1; i <= 3; i++) {
                if (entryPhotos[i]) {
                    photoElements.push(`<img src="${entryPhotos[i].data}" alt="Photo ${i}" class="entry-photo">`);
                }
            }
            
            if (photoElements.length > 0) {
                return `<div class="entry-photos">${photoElements.join('')}</div>`;
            }
            return '';
        }

        // Update export buttons
        function updateExportButtons() {
            const hasEntries = workEntries.length > 0;
            document.getElementById('download-btn').disabled = !hasEntries;
            document.getElementById('photos-btn').disabled = !hasEntries;
            document.getElementById('export-message').style.display = hasEntries ? 'none' : 'block';
        }

        // Generate CSV
        function generateCSV() {
            const headers = [
                'Date', 'Location', 'Location Details', 'Contractor', 'Work Description',
                'Work Category', 'Manpower', 'Plant Type', 'Plant Number', 'Plant Other Type',
                'Material Usage', 'Resource Utilization', 'Safety Observations',
                'Weekly Programme', 'Remarks', 'Photo 1', 'Photo 2', 'Photo 3', 'Timestamp'
            ];
            
            const csvContent = [
                headers.join(','),
                ...workEntries.map(entry => [
                    entry.date,
                    `"${entry.location}"`,
                    `"${entry.locationDetails}"`,
                    `"${entry.contractor}"`,
                    `"${(entry.workDescription || '').replace(/"/g, '""')}"`,
                    `"${entry.workCategory}"`,
                    entry.manpower,
                    `"${entry.plantType}"`,
                    entry.plantNumber,
                    `"${entry.plantOtherType || ''}"`,
                    `"${(entry.materialUsage || '').replace(/"/g, '""')}"`,
                    `"${(entry.resourceUtilization || '').replace(/"/g, '""')}"`,
                    `"${(entry.safetyObservations || '').replace(/"/g, '""')}"`,
                    `"${(entry.weeklyProgramme || '').replace(/"/g, '""')}"`,
                    `"${(entry.remarks || '').replace(/"/g, '""')}"`,
                    `"${entry.photos[1] ? entry.photos[1].name : ''}"`,
                    `"${entry.photos[2] ? entry.photos[2].name : ''}"`,
                    `"${entry.photos[3] ? entry.photos[3].name : ''}"`,
                    `"${entry.timestamp}"`
                ].join(','))
            ].join('\n');
            
            return csvContent;
        }

        // Download CSV
        function downloadCSV() {
            try {
                const csvContent = generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `site_daily_report_${document.getElementById('report-date').value}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('‚úÖ CSV downloaded successfully!');
            } catch (error) {
                alert('‚ùå CSV export failed. Please try again.');
            }
        }

        // Download photos
        function downloadPhotos() {
            try {
                createHTMLPhotoReport();
            } catch (error) {
                alert('‚ùå Photo export failed. Please try again.');
            }
        }

        // Create HTML photo report
        function createHTMLPhotoReport() {
            let photoHTML = `<!DOCTYPE html>
<html>
<head>
    <title>Site Report Photos - ${document.getElementById('report-date').value}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.5; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .entry { margin-bottom: 40px; border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        .entry-header { background: #f0f0f0; padding: 10px; margin: -20px -20px 15px -20px; border-radius: 8px 8px 0 0; }
        .photo-container { margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        img { max-width: 100%; height: auto; margin: 10px 0; border: 1px solid #ccc; }
        .details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .detail { padding: 5px 0; }
        .section-title { font-weight: bold; color: #2563eb; margin: 15px 0 5px 0; }
        .remarks { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .safety { background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Site Daily Report - Photos</h1>
        <h2>üìÖ Date: ${document.getElementById('report-date').value}</h2>
        <p>üïê Generated: ${new Date().toLocaleString()}</p>
        <p>üìã Total Entries: ${workEntries.length}</p>
    </div>`;

            workEntries.forEach((entry, index) => {
                photoHTML += `
    <div class="entry">
        <div class="entry-header">
            <h3>Entry #${index + 1}</h3>
        </div>
        
        <div class="details">
            <div class="detail"><strong>üìç Location:</strong> ${entry.location}</div>
            <div class="detail"><strong>üë∑ Contractor:</strong> ${entry.contractor}</div>
            <div class="detail"><strong>üîß Category:</strong> ${entry.workCategory}</div>
            <div class="detail"><strong>üë• Manpower:</strong> ${entry.manpower}</div>
        </div>
        
        <div class="detail"><strong>üìç Location Details:</strong> ${entry.locationDetails}</div>
        <div class="detail"><strong>üèóÔ∏è Plant & Equipment:</strong> ${entry.plantNumber} x ${entry.plantType} ${entry.plantOtherType}</div>
        <div class="detail"><strong>‚è∞ Timestamp:</strong> ${entry.timestamp}</div>
        
        ${entry.workDescription ? `
        <div class="section-title">üîß Work Description:</div>
        <div>${entry.workDescription}</div>
        ` : ''}
        
        ${entry.remarks ? `
        <div class="section-title">üí¨ Remarks:</div>
        <div class="remarks">${entry.remarks}</div>
        ` : ''}
        
        ${entry.safetyObservations ? `
        <div class="section-title">üõ°Ô∏è Safety Observations:</div>
        <div class="safety">${entry.safetyObservations}</div>
        ` : ''}`;
                
                for (let i = 1; i <= 3; i++) {
                    if (entry.photos[i]) {
                        photoHTML += `
        <div class="photo-container">
            <div class="section-title">üì∏ Photo ${i}: ${entry.photos[i].name}</div>
            <img src="${entry.photos[i].data}" alt="Photo ${i}">
        </div>`;
                    }
                }
                
                photoHTML += `    </div>`;
            });

            photoHTML += `</body></html>`;

            // Download
            const blob = new Blob([photoHTML], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `site_report_photos_${document.getElementById('report-date').value}.html`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Photos exported successfully!');
        }

        // Save draft
        function saveDraft() {
            try {
                const draftData = {
                    date: document.getElementById('report-date').value,
                    location: document.getElementById('location').value,
                    locationDetails: document.getElementById('location-details').value,
                    contractor: document.getElementById('contractor').value,
                    workDescription: document.getElementById('work-description').value,
                    workCategory: document.getElementById('work-category').value,
                    manpower: document.getElementById('manpower').value,
                    plantType: document.getElementById('plant-type').value,
                    plantNumber: document.getElementById('plant-number').value,
                    plantOtherType: document.getElementById('plant-other').value,
                    materialUsage: document.getElementById('material-usage').value,
                    resourceUtilization: document.getElementById('resource-utilization').value,
                    safetyObservations: document.getElementById('safety-observations').value,
                    weeklyProgramme: document.getElementById('weekly-programme').value,
                    remarks: document.getElementById('remarks').value,
                    photos: photos,
                    workEntries: workEntries,
                    savedAt: new Date().toLocaleString()
                };
                
                if (typeof Storage !== "undefined") {
                    try {
                        localStorage.setItem('siteDailyReportDraft', JSON.stringify(draftData));
                        alert('‚úÖ Draft saved successfully!');
                    } catch (e) {
                        sessionStorage.setItem('siteDailyReportDraft', JSON.stringify(draftData));
                        alert('‚úÖ Draft saved for this session!');
                    }
                } else {
                    alert('‚ùå Browser storage not supported.');
                }
            } catch (error) {
                alert('‚ùå Save failed: ' + error.message);
            }
        }

        // Submit report
        function submitReport() {
            if (workEntries.length === 0) {
                alert('‚ùå Cannot submit empty report.\n\nPlease add at least one work entry.');
                return;
            }
            
            const reportData = {
                date: document.getElementById('report-date').value,
                totalEntries: workEntries.length,
                submittedAt: new Date().toLocaleString()
            };
            
            const referenceNumber = `SDR-${reportData.date.replace(/-/g, '')}-${Date.now()}`;
            
            if (confirm(`üìß Submit Report?\n\n‚Ä¢ Date: ${reportData.date}\n‚Ä¢ Entries: ${reportData.totalEntries}\n‚Ä¢ Reference: ${referenceNumber}\n\nContinue?`)) {
                // Clear draft
                try {
                    if (typeof Storage !== "undefined") {
                        localStorage.removeItem('siteDailyReportDraft');
                        sessionStorage.removeItem('siteDailyReportDraft');
                    }
                } catch (error) {
                    console.warn('Could not clear draft');
                }
                
                alert(`‚úÖ Report submitted successfully!\n\n‚Ä¢ Reference: ${referenceNumber}\n‚Ä¢ Submitted: ${reportData.submittedAt}`);
                
                // Ask about new report
                setTimeout(() => {
                    if (confirm('üÜï Start new report?\n\nThis will clear all data.')) {
                        location.reload();
                    }
                }, 2000);
            }
        }

        // Load draft
        function loadDraft() {
            try {
                let draftData = null;
                
                if (typeof Storage !== "undefined") {
                    try {
                        draftData = localStorage.getItem('siteDailyReportDraft');
                        if (!draftData) {
                            draftData = sessionStorage.getItem('siteDailyReportDraft');
                        }
                    } catch (e) {
                        draftData = sessionStorage.getItem('siteDailyReportDraft');
                    }
                }
                
                if (draftData) {
                    const data = JSON.parse(draftData);
                    
                    // Load all form data
                    document.getElementById('report-date').value = data.date || '';
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('location-details').value = data.locationDetails || '';
                    document.getElementById('contractor').value = data.contractor || '';
                    document.getElementById('work-description').value = data.workDescription || '';
                    document.getElementById('work-category').value = data.workCategory || '';
                    document.getElementById('manpower').value = data.manpower || '';
                    document.getElementById('plant-type').value = data.plantType || '';
                    document.getElementById('plant-number').value = data.plantNumber || '';
                    document.getElementById('plant-other').value = data.plantOtherType || '';
                    document.getElementById('material-usage').value = data.materialUsage || '';
                    document.getElementById('resource-utilization').value = data.resourceUtilization || '';
                    document.getElementById('safety-observations').value = data.safetyObservations || '';
                    document.getElementById('weekly-programme').value = data.weeklyProgramme || '';
                    document.getElementById('remarks').value = data.remarks || '';
                    
                    // Load photos
                    if (data.photos) {
                        photos = data.photos;
                        for (let i = 1; i <= 3; i++) {
                            if (photos[i]) {
                                try {
                                    document.getElementById(`photo${i}-img`).src = photos[i].data;
                                    document.getElementById(`photo${i}-name`).textContent = photos[i].name;
                                    document.getElementById(`photo${i}-preview`).classList.remove('hidden');
                                    document.getElementById(`photo${i}-input`).classList.add('hidden');
                                } catch (e) {
                                    console.warn(`Could not load photo ${i}`);
                                }
                            }
                        }
                    }
                    
                    // Load work entries
                    if (data.workEntries) {
                        workEntries = data.workEntries;
                        updateEntriesDisplay();
                        updateExportButtons();
                    }
                    
                    toggleOtherPlant();
                    
                    alert(`‚úÖ Draft loaded successfully!\n\nSaved: ${data.savedAt}`);
                    return true;
                }
            } catch (error) {
                alert('‚ùå Error loading draft. Starting fresh.');
            }
            return false;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            init();
            
            // Check for draft after a short delay
            setTimeout(() => {
                try {
                    let hasDraft = false;
                    if (typeof Storage !== "undefined") {
                        hasDraft = localStorage.getItem('siteDailyReportDraft') || sessionStorage.getItem('siteDailyReportDraft');
                    }
                    
                    if (hasDraft) {
                        if (confirm('üìÑ Found saved draft. Continue working on it?')) {
                            loadDraft();
                        }
                    }
                } catch (error) {
                    console.warn('Draft check failed');
                }
            }, 1000);
        });

        console.log('Site Daily Report app script loaded');
    </script>
</body>
</html>
